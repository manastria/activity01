---
title: "Phase 4 - RÃ¨gles de filtrage pour le VPN"
description: "Configuration des rÃ¨gles de filtrage sur le Stormshield pour autoriser et sÃ©curiser les connexions VPN SSL"
draft: true
---

# Phase 4 : RÃ¨gles de filtrage pour le VPN SSL

## Informations

- **DurÃ©e estimÃ©e** : 1h30
- **PrÃ©requis** : Phases 1, 2 et 3 terminÃ©es et validÃ©es
- **RÃ´le principal** : Ã‰tudiant Y (Serveur VPN)

---

## Objectifs de cette phase

- âœ… Comprendre les flux rÃ©seau nÃ©cessaires au VPN
- âœ… CrÃ©er les rÃ¨gles de filtrage pour autoriser les connexions VPN entrantes
- âœ… Autoriser le trafic des clients VPN vers le rÃ©seau interne
- âœ… Configurer le NAT si nÃ©cessaire
- âœ… Optimiser l'ordre des rÃ¨gles
- âœ… Tester et valider les rÃ¨gles crÃ©Ã©es

---

## Contexte : Comprendre les flux rÃ©seau du VPN

### Les 3 flux essentiels Ã  autoriser

Pour que le VPN fonctionne, il faut autoriser **3 types de flux** diffÃ©rents :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  FLUX 1 : Ã‰tablissement de la connexion VPN                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                                             â”‚
â”‚  Client VPN (172.25.X.10) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶       â”‚
â”‚                              TCP/443                        â”‚
â”‚                       SNS OUT (172.25.Y.254)                â”‚
â”‚                                                             â”‚
â”‚  BUT : Permettre au client de se connecter au serveur VPN   â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  FLUX 2 : Clients VPN vers rÃ©seau interne                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                             â”‚
â”‚  Client VPN (10.Y.100.5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶          â”‚
â”‚                                                             â”‚
â”‚                   RÃ©seau interne (10.Y.1.0/24)              â”‚
â”‚                         â†“                                   â”‚
â”‚                   Serveur Debian (10.Y.1.20)                â”‚
â”‚                                                             â”‚
â”‚  BUT : Permettre l'accÃ¨s aux ressources internes            â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  FLUX 3 : RÃ©seau interne vers clients VPN (rÃ©ponses)        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                             â”‚
â”‚  Serveur Debian (10.Y.1.20) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶       â”‚
â”‚                                                             â”‚
â”‚                   Client VPN (10.Y.100.5)                   â”‚
â”‚                                                             â”‚
â”‚  BUT : Permettre les rÃ©ponses aux requÃªtes                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Zones de sÃ©curitÃ© impliquÃ©es

Le Stormshield utilise des **zones de sÃ©curitÃ©** :
- ğŸ”´ **out** (Internet/rouge) : Zone non fiable
- ğŸŸ¢ **in** (Interne/vert) : Zone de confiance
- ğŸ”µ **vpn_ssl** (VPN) : Zone intermÃ©diaire crÃ©Ã©e automatiquement

:::tip[Zone VPN SSL]
Quand vous activez le VPN SSL, le Stormshield crÃ©e automatiquement une zone virtuelle `vpn_ssl`.
Les clients VPN connectÃ©s sont considÃ©rÃ©s comme faisant partie de cette zone.
:::

---

## Ã‰tape 4.1 : VÃ©rification de la zone VPN SSL

:::caution[RÃ´le spÃ©cifique]
**Cette phase est rÃ©alisÃ©e par l'Ã‰tudiant Y** (Serveur VPN).
L'Ã‰tudiant X observe et comprend les principes.
:::

### ğŸ”§ TÃ¢che : VÃ©rifier la crÃ©ation de la zone VPN

**1. Se connecter Ã  l'interface web du SNS**

```
URL : https://172.25.Y.254/admin
Login : admin
Mot de passe : admin
```

**2. AccÃ©der Ã  la gestion des interfaces**

```
Configuration â†’ RÃ©seau â†’ Interfaces
```

**3. VÃ©rifier la prÃ©sence de l'interface VPN SSL**

Dans la liste des interfaces, vous devriez voir :

| Interface   | Type          | Ã‰tat   | Zone                  |
| ----------- | ------------- | ------ | --------------------- |
| out         | Physique      | UP     | Internet (rouge)      |
| in          | Physique      | UP     | RÃ©seau interne (vert) |
| **vpn_ssl** | **Virtuelle** | **UP** | **VPN SSL (bleu)**    |

:::tip[Interface virtuelle]
L'interface `vpn_ssl` est crÃ©Ã©e automatiquement lors de l'activation du service VPN SSL.
Elle reprÃ©sente tous les clients VPN connectÃ©s.
:::

**4. VÃ©rifier les propriÃ©tÃ©s de la zone VPN**

Cliquer sur l'interface `vpn_ssl` :
- **Type de zone** : VPN SSL
- **Niveau de sÃ©curitÃ©** : IntermÃ©diaire (entre Internet et Interne)
- **RÃ©seau associÃ©** : Pool VPN (10.Y.100.0/26)

:::tip[Validation Ã‰tape 4.1]
âœ… L'interface `vpn_ssl` est prÃ©sente et active (UP)
âœ… La zone VPN SSL est de type "VPN SSL"
âœ… Capture d'Ã©cran : Liste des interfaces avec vpn_ssl visible
:::

---

## Ã‰tape 4.2 : CrÃ©ation de la rÃ¨gle 1 - Autoriser les connexions VPN entrantes

### ğŸ¯ Objectif
Autoriser les clients distants Ã  se connecter au serveur VPN sur le port 443.

### ğŸ”§ TÃ¢che : CrÃ©er la rÃ¨gle de connexion VPN

**1. AccÃ©der aux rÃ¨gles de filtrage**

```
Configuration â†’ Politique de sÃ©curitÃ© â†’ Filtrage et NAT â†’ RÃ¨gles de filtrage
```

**2. CrÃ©er une nouvelle rÃ¨gle**

Cliquer sur `Ajouter` (en haut de la liste) :

**Informations gÃ©nÃ©rales :**
- **Nom de la rÃ¨gle** : `Autoriser connexions VPN SSL entrantes`
- **Ã‰tat** : âœ… ActivÃ©
- **Action** : `Accepter` (PASS - couleur verte)
- **Position** : Placer en haut de la liste (avant les autres rÃ¨gles)

**Onglet Origine :**
- **Source** : `any` (ou `Internet` si l'objet existe)
  - Explication : N'importe quel client sur Internet peut tenter de se connecter
  - L'authentification LDAP filtrera les utilisateurs autorisÃ©s

**Onglet Destination :**
- **Destination** : Cliquer sur `+`
  - Type : `Objet de type Firewall`
  - SÃ©lectionner : `Firewall_out` (l'interface OUT du SNS - 172.25.Y.254)
  - Valider

**Onglet Service :**
- **Service** : Cliquer sur `+`
  - Type : `Service prÃ©dÃ©fini` ou `Service personnalisÃ©`
  - Service : `https` (TCP/443)
  - Valider

:::tip[Port 443]
On autorise le port 443 (HTTPS) car c'est le port configurÃ© pour le VPN SSL en Phase 3.
Si vous aviez choisi le port 1194, il faudrait autoriser `openvpn` (UDP/1194).
:::

**Onglet Inspection :**
- **Inspection SSL** : `DÃ©sactivÃ©e` (pas d'inspection du tunnel VPN)
- **IPS** : `DÃ©sactivÃ©e` (pour ne pas interfÃ©rer avec le VPN)

**Onglet Logs :**
- **Logs** : âœ… `Activer les logs`
  - Important pour dÃ©boguer les connexions VPN

**3. CrÃ©er la rÃ¨gle**

Cliquer sur `CrÃ©er`.

:::tip[Explication]
Cette rÃ¨gle dit :
"Autoriser n'importe qui (any) Ã  se connecter Ã  l'interface OUT du firewall (172.25.Y.254) sur le port 443 (https)."

Le serveur VPN Ã©coute sur ce port et gÃ©rera l'authentification des utilisateurs.
:::

:::tip[Validation Ã‰tape 4.2]
- âœ… La rÃ¨gle apparaÃ®t en premiÃ¨re position (ou dans le top 3)
- âœ… Action : ACCEPT (vert)
- âœ… Source : any â†’ Destination : Firewall_out â†’ Service : https
- âœ… Capture d'Ã©cran : RÃ¨gle de connexion VPN crÃ©Ã©e
:::

---

## Ã‰tape 4.3 : CrÃ©ation de la rÃ¨gle 2 - Clients VPN vers rÃ©seau interne

### ğŸ¯ Objectif
Autoriser les clients VPN connectÃ©s (zone vpn_ssl) Ã  accÃ©der au rÃ©seau interne (zone in).

### ğŸ”§ TÃ¢che : CrÃ©er la rÃ¨gle d'accÃ¨s au rÃ©seau interne

**1. CrÃ©er une nouvelle rÃ¨gle**

Cliquer sur `Ajouter` :

**Informations gÃ©nÃ©rales :**
- **Nom** : `VPN clients vers rÃ©seau interne`
- **Ã‰tat** : âœ… ActivÃ©
- **Action** : `Accepter` (PASS - vert)

**Onglet Origine :**
- **Source** : Cliquer sur `+`
  - Type : `Interface` ou `RÃ©seau`
  - Option 1 : SÃ©lectionner l'interface `vpn_ssl`
  - Option 2 : CrÃ©er un objet rÃ©seau `10.Y.100.0/26` (le pool VPN)
  - Valider

:::tip[Quelle option choisir ?]
Les deux fonctionnent :
- **Interface vpn_ssl** : Plus simple, couvre automatiquement tous les clients VPN
- **RÃ©seau 10.Y.100.0/26** : Plus prÃ©cis, permet un contrÃ´le granulaire

Pour cette activitÃ©, utilisez **l'interface vpn_ssl**.
:::

**Onglet Destination :**
- **Destination** : Cliquer sur `+`
  - Type : `RÃ©seau`
  - Si l'objet existe : SÃ©lectionner `Reseau_Interne_Y` (10.Y.1.0/24)
  - Sinon, crÃ©er l'objet :
    - Nom : `Reseau_Interne_Y`
    - Adresse : `10.Y.1.0/24`
  - Valider

**Onglet Service :**
- **Service** : `any` (tous les services)
  - Explication : On autorise les clients VPN Ã  accÃ©der Ã  tous les services internes
  - En production, on limiterait (ex: HTTP, SSH, SMB seulement)

**Onglet Inspection :**
- **Inspection** : `ActivÃ©e` (optionnel mais recommandÃ©)
- **IPS** : `ActivÃ©e` (protection)

**Onglet Logs :**
- **Logs** : âœ… ActivÃ©s

**2. CrÃ©er la rÃ¨gle**

:::tip[Explication]
Cette rÃ¨gle dit :
"Autoriser les clients VPN (zone vpn_ssl) Ã  accÃ©der au rÃ©seau interne (10.Y.1.0/24) sur tous les ports."

Cela permet aux clients VPN d'accÃ©der au serveur Debian (10.Y.1.20) et Ã  toutes les ressources internes.
:::

:::tip[Validation Ã‰tape 4.3]
- âœ… La rÃ¨gle est crÃ©Ã©e
- âœ… Source : vpn_ssl â†’ Destination : 10.Y.1.0/24 â†’ Service : any
- âœ… Action : ACCEPT
- âœ… Capture d'Ã©cran : RÃ¨gle clients VPN vers interne
:::

---

## Ã‰tape 4.4 : CrÃ©ation de la rÃ¨gle 3 - RÃ©seau interne vers clients VPN (rÃ©ponses)

### ğŸ¯ Objectif
Autoriser les serveurs internes Ã  rÃ©pondre aux clients VPN.

### ğŸ”§ TÃ¢che : CrÃ©er la rÃ¨gle de retour

**1. CrÃ©er une nouvelle rÃ¨gle**

Cliquer sur `Ajouter` :

**Informations gÃ©nÃ©rales :**
- **Nom** : `RÃ©seau interne vers clients VPN (rÃ©ponses)`
- **Ã‰tat** : âœ… ActivÃ©
- **Action** : `Accepter` (PASS - vert)

**Onglet Origine :**
- **Source** : `Reseau_Interne_Y` (10.Y.1.0/24)

**Onglet Destination :**
- **Destination** : Interface `vpn_ssl` ou rÃ©seau `10.Y.100.0/26`

**Onglet Service :**
- **Service** : `any`

**Onglet Options avancÃ©es :**
- **Ã‰tat de connexion** : `Ã‰tablie` (established)
  - Cette option limite la rÃ¨gle aux rÃ©ponses de connexions dÃ©jÃ  initiÃ©es
  - SÃ©curitÃ© : empÃªche les serveurs internes d'initier des connexions vers les VPN

:::tip[Ã‰tat "Ã‰tablie"]
En sÃ©lectionnant "Ã‰tablie", on dit :
"Autoriser uniquement les paquets de rÃ©ponse Ã  des connexions dÃ©jÃ  ouvertes par les clients VPN."

Cela empÃªche un serveur compromis d'initier des connexions sortantes vers les clients VPN.
:::

**Onglet Logs :**
- **Logs** : âœ… ActivÃ©s

**2. CrÃ©er la rÃ¨gle**

:::note[Cette rÃ¨gle est-elle vraiment nÃ©cessaire ?]
Sur certains firewalls modernes avec **connexion tracking** (suivi de connexion), cette rÃ¨gle peut Ãªtre optionnelle car les rÃ©ponses sont automatiquement autorisÃ©es.

**Stormshield** fait du connexion tracking, donc techniquement cette rÃ¨gle n'est pas obligatoire.

**Cependant**, pour la pÃ©dagogie et la clartÃ© :
- âœ… On la crÃ©e quand mÃªme pour comprendre le flux complet
- âœ… Cela rend la politique de filtrage plus explicite
- âœ… Compatible avec tous les types de firewalls
:::

:::tip[Validation Ã‰tape 4.4]
- âœ… La rÃ¨gle est crÃ©Ã©e
- âœ… Source : 10.Y.1.0/24 â†’ Destination : vpn_ssl â†’ Service : any
- âœ… Ã‰tat : Ã‰tablie (established)
- âœ… Capture d'Ã©cran : RÃ¨gle rÃ©seau interne vers VPN
:::

---

## Ã‰tape 4.5 : VÃ©rification et optimisation de l'ordre des rÃ¨gles

### ğŸ¯ Objectif
S'assurer que les rÃ¨gles sont dans le bon ordre pour un fonctionnement optimal et sÃ©curisÃ©.

### ğŸ”§ TÃ¢che : Organiser les rÃ¨gles de filtrage

**1. AccÃ©der Ã  la vue d'ensemble des rÃ¨gles**

```
Configuration â†’ Politique de sÃ©curitÃ© â†’ Filtrage et NAT â†’ RÃ¨gles de filtrage
```

**2. Ordre recommandÃ© des rÃ¨gles**

Les rÃ¨gles doivent Ãªtre organisÃ©es par ordre de spÃ©cificitÃ© (du plus spÃ©cifique au plus gÃ©nÃ©ral) :

```
Position â”‚ Nom de la rÃ¨gle                               â”‚ Action
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€
    1    â”‚ Autoriser connexions VPN SSL entrantes        â”‚ ACCEPT
    2    â”‚ VPN clients vers rÃ©seau interne               â”‚ ACCEPT
    3    â”‚ RÃ©seau interne vers clients VPN (rÃ©ponses)    â”‚ ACCEPT
    4    â”‚ Firewall vers Internet (Phase 1)              â”‚ ACCEPT
    5    â”‚ RÃ©seau interne vers Internet (Phase 1)        â”‚ ACCEPT
 â”€â”€â”€â”€â”€â”€â”€ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”€â”€â”€â”€â”€â”€
 Impliciteâ”‚ Deny All (tout bloquer par dÃ©faut)           â”‚ BLOCK
```

**3. RÃ©organiser si nÃ©cessaire**

Si vos rÃ¨gles ne sont pas dans cet ordre :
- SÃ©lectionner une rÃ¨gle
- Utiliser les flÃ¨ches â¬†ï¸ â¬‡ï¸ pour la dÃ©placer
- Placer les rÃ¨gles VPN en tÃªte (positions 1-3)

:::tip[Pourquoi cet ordre ?]
**Principe de sÃ©curitÃ©** : Les rÃ¨gles les plus spÃ©cifiques en premier.

1. **RÃ¨gles VPN** (trÃ¨s spÃ©cifiques : port 443, zones vpn_ssl) â†’ En premier
2. **RÃ¨gles gÃ©nÃ©rales** (firewall vers Internet, rÃ©seau interne) â†’ Ensuite
3. **Deny All implicite** â†’ Fin (automatique)

Si on inversait, les rÃ¨gles VPN ne seraient jamais Ã©valuÃ©es !
:::

**4. Appliquer les modifications**

Cliquer sur `Appliquer` pour activer le nouvel ordre.

:::tip[Validation Ã‰tape 4.5]
- âœ… Les 3 rÃ¨gles VPN sont en positions 1-3
- âœ… Les rÃ¨gles de la Phase 1 sont aprÃ¨s
- âœ… Aucune erreur de configuration
- âœ… Capture d'Ã©cran : Liste complÃ¨te des rÃ¨gles dans le bon ordre
:::

---

## Ã‰tape 4.6 : Configuration NAT pour les clients VPN (si nÃ©cessaire)

### ğŸ¯ Objectif
VÃ©rifier si un NAT est nÃ©cessaire pour les clients VPN.

### Contexte : NAT pour les clients VPN ?

**Question** : Les clients VPN (10.Y.100.0/26) ont-ils besoin d'un NAT pour accÃ©der au rÃ©seau interne (10.Y.1.0/24) ?

**RÃ©ponse** : **NON**, car :
- Les deux rÃ©seaux sont privÃ©s (10.x.x.x)
- Le SNS route directement entre vpn_ssl et in
- Pas besoin de traduction d'adresse

**MAIS** : Si les clients VPN veulent accÃ©der Ã  **Internet** (pas juste au rÃ©seau interne), alors oui, il faut un NAT.

### ğŸ”§ TÃ¢che : CrÃ©er une rÃ¨gle NAT pour VPN vers Internet (optionnel)

:::note[Cette Ã©tape est optionnelle]
Dans notre activitÃ©, le **split tunneling** est activÃ©. Cela signifie que :
- Trafic vers 10.Y.1.0/24 â†’ passe par le VPN
- Trafic vers Internet â†’ passe directement par la connexion locale du client

**Si vous aviez activÃ© le Full Tunnel**, cette rÃ¨gle NAT serait nÃ©cessaire.
:::

**Pour crÃ©er la rÃ¨gle NAT (si besoin) :**

1. AccÃ©der au NAT :
```
Configuration â†’ Politique de sÃ©curitÃ© â†’ Filtrage et NAT â†’ NAT
```

2. CrÃ©er une rÃ¨gle :
- **Nom** : `NAT VPN clients vers Internet`
- **Ã‰tat** : âœ… ActivÃ©

**Onglet Original :**
- **Source** : Interface `vpn_ssl` ou rÃ©seau `10.Y.100.0/26`
- **Destination** : `Internet`
- **Service** : `any`

**Onglet TranslatÃ© :**
- **Source** : `Firewall_out` (172.25.Y.254)
- **Destination** : Original
- **Service** : Original

3. CrÃ©er

:::tip[Pour cette activitÃ©]
**Vous pouvez sauter cette Ã©tape** si vous avez configurÃ© le split tunneling (Phase 3).
Le NAT de la Phase 1 (rÃ©seau interne vers Internet) suffit.
:::

:::tip[Validation Ã‰tape 4.6]
- âœ… Pas de NAT nÃ©cessaire pour VPN â†’ rÃ©seau interne (routage direct)
- âœ… (Optionnel) NAT crÃ©Ã© si Full Tunnel activÃ©
:::

---

## Ã‰tape 4.7 : Test prÃ©liminaire des rÃ¨gles

### ğŸ¯ Objectif
VÃ©rifier que les rÃ¨gles crÃ©Ã©es sont bien prises en compte par le firewall.

### ğŸ”§ TÃ¢che : Tester l'accessibilitÃ© du serveur VPN

**1. Depuis la VM Client VPN (Ã‰tudiant X)**

Tester la connectivitÃ© vers le serveur VPN :

```bash
# Test 1 : Ping vers le serveur VPN
ping -c 4 172.25.Y.254

# Test 2 : Test du port 443 (VPN SSL)
nc -zv 172.25.Y.254 443

# Ou avec telnet :
telnet 172.25.Y.254 443

# Ou avec curl :
curl -k https://172.25.Y.254/
```

**RÃ©sultats attendus :**
- âœ… Ping : RÃ©ponses OK
- âœ… Port 443 : Ouvert (Connected / Connection succeeded)
- âœ… Curl : Page HTML du portail VPN

:::caution[Si le port 443 est fermÃ©]
VÃ©rifiez que :
- La rÃ¨gle "Autoriser connexions VPN SSL entrantes" est bien crÃ©Ã©e
- La rÃ¨gle est en position haute (avant les deny)
- La rÃ¨gle est activÃ©e (âœ…)
- Le service VPN SSL est dÃ©marrÃ© (Phase 3)
:::

**2. Consulter les logs de connexion**

```
Monitoring â†’ Logs â†’ Filtrage et NAT â†’ Connexions
```

Filtrer par :
- **Destination** : 172.25.Y.254
- **Service** : https (443)

Vous devriez voir :
- ğŸŸ¢ Lignes vertes (PASS) pour les tentatives de connexion au port 443
- **RÃ¨gle appliquÃ©e** : "Autoriser connexions VPN SSL entrantes"

:::tip[Validation Ã‰tape 4.7]
- âœ… Le port 443 est accessible depuis le Client VPN
- âœ… Les logs montrent les connexions autorisÃ©es (PASS)
- âœ… La bonne rÃ¨gle est appliquÃ©e dans les logs
- âœ… Capture d'Ã©cran : Logs de connexion montrant l'accÃ¨s au port 443
:::

---

## Ã‰tape 4.8 : Analyse de sÃ©curitÃ© des rÃ¨gles

### ğŸ”§ TÃ¢che : VÃ©rifier que les rÃ¨gles respectent les bonnes pratiques

**1. Checklist de sÃ©curitÃ©**

VÃ©rifiez que vos rÃ¨gles respectent les principes suivants :

| Principe                               | VÃ©rification                                           | âœ…/âŒ |
| -------------------------------------- | ------------------------------------------------------ | ----- |
| **Principe du moindre privilÃ¨ge**      | Les rÃ¨gles autorisent uniquement le nÃ©cessaire         |       |
| **RÃ¨gles spÃ©cifiques avant gÃ©nÃ©rales** | Ordre : VPN â†’ Firewall â†’ RÃ©seau interne                |       |
| **Logs activÃ©s**                       | Toutes les rÃ¨gles VPN ont les logs activÃ©s             |       |
| **Ã‰tat de connexion**                  | RÃ¨gle "rÃ©seau interne vers VPN" limitÃ©e Ã  "Ã‰tablie"    |       |
| **Services limitÃ©s**                   | VPN entrante limitÃ©e au port 443 uniquement            |       |
| **Source contrÃ´lÃ©e**                   | VPN clients vers interne : source = vpn_ssl uniquement |       |
| **Deny All implicite**                 | Tout ce qui n'est pas autorisÃ© est bloquÃ©              |       |

**2. Test nÃ©gatif (important)**

VÃ©rifier que ce qui **ne doit pas** Ãªtre autorisÃ© est bien bloquÃ© :

Depuis la VM Client VPN (avant connexion VPN) :
```bash
# Tentative d'accÃ¨s direct au serveur Debian (doit Ã©chouer)
ping 10.Y.1.20
# Attendu : Aucune rÃ©ponse ou "Destination Host Unreachable"

# Tentative de connexion SSH directe (doit Ã©chouer)
ssh techservices@10.Y.1.20
# Attendu : Timeout ou "No route to host"
```

**RÃ©sultat attendu :** âŒ Ã‰chec (c'est ce qu'on veut !)

Pourquoi ? Car le client VPN n'est **pas encore connectÃ© au VPN**.
Il est sur le rÃ©seau 172.25.X.0/16 (Internet), pas sur le rÃ©seau 10.Y.100.0/26 (VPN).

:::tip[C'est normal que Ã§a ne marche pas !]
Si vous pouviez accÃ©der au serveur Debian (10.Y.1.20) **sans** Ãªtre connectÃ© au VPN, cela signifierait :
- âŒ Soit une erreur de configuration rÃ©seau
- âŒ Soit une faille de sÃ©curitÃ© majeure

Le but du VPN est justement de **restreindre l'accÃ¨s** aux ressources internes.
:::

:::tip[Validation Ã‰tape 4.8]
- âœ… Tous les critÃ¨res de la checklist sont respectÃ©s
- âœ… Les tests nÃ©gatifs Ã©chouent (preuve que la sÃ©curitÃ© fonctionne)
- âœ… Capture d'Ã©cran : Tentative Ã©chouÃ©e de ping vers 10.Y.1.20 (avant VPN)
:::

---

## âœ… Tableau de validation de la Phase 4

ComplÃ©tez ce tableau dans votre compte-rendu :

| Ã‰lÃ©ment               | Description                             | Valeur/Ã‰tat      | âœ…/âŒ |
| --------------------- | --------------------------------------- | ---------------- | ----- |
| **Zone VPN SSL**      | Interface virtuelle crÃ©Ã©e               | PrÃ©sente et UP   |       |
| **RÃ¨gle 1**           | Autoriser connexions VPN entrantes      | CrÃ©Ã©e et activÃ©e |       |
| RÃ¨gle 1 - Source      | any (Internet)                          | ConfigurÃ©        |       |
| RÃ¨gle 1 - Destination | Firewall_out                            | ConfigurÃ©        |       |
| RÃ¨gle 1 - Service     | https (443)                             | ConfigurÃ©        |       |
| **RÃ¨gle 2**           | VPN clients vers rÃ©seau interne         | CrÃ©Ã©e et activÃ©e |       |
| RÃ¨gle 2 - Source      | vpn_ssl                                 | ConfigurÃ©        |       |
| RÃ¨gle 2 - Destination | 10.Y.1.0/24                             | ConfigurÃ©        |       |
| RÃ¨gle 2 - Service     | any                                     | ConfigurÃ©        |       |
| **RÃ¨gle 3**           | RÃ©seau interne vers VPN (rÃ©ponses)      | CrÃ©Ã©e et activÃ©e |       |
| RÃ¨gle 3 - Source      | 10.Y.1.0/24                             | ConfigurÃ©        |       |
| RÃ¨gle 3 - Destination | vpn_ssl                                 | ConfigurÃ©        |       |
| RÃ¨gle 3 - Ã‰tat        | Ã‰tablie                                 | ConfigurÃ©        |       |
| **Ordre des rÃ¨gles**  | VPN en positions 1-3                    | Correct          |       |
| **Logs**              | ActivÃ©s sur toutes les rÃ¨gles VPN       | ActivÃ©s          |       |
| **Test port 443**     | Accessible depuis Client VPN            | Accessible       |       |
| **Test nÃ©gatif**      | Serveur interne non accessible sans VPN | BloquÃ© (normal)  |       |

---

## âœ… CritÃ¨res de validation de la Phase 4

Avant de passer Ã  la Phase 5, assurez-vous que :

- [ ] L'interface virtuelle `vpn_ssl` est crÃ©Ã©e et active
- [ ] La rÃ¨gle 1 autorise les connexions VPN entrantes (any â†’ Firewall_out:443)
- [ ] La rÃ¨gle 2 autorise les clients VPN vers le rÃ©seau interne (vpn_ssl â†’ 10.Y.1.0/24)
- [ ] La rÃ¨gle 3 autorise les rÃ©ponses (10.Y.1.0/24 â†’ vpn_ssl, Ã©tat "Ã‰tablie")
- [ ] Les 3 rÃ¨gles VPN sont en positions 1-3 (avant les autres)
- [ ] Tous les logs sont activÃ©s sur les rÃ¨gles VPN
- [ ] Le port 443 est accessible depuis le Client VPN (test nc/telnet/curl)
- [ ] Les logs montrent les connexions autorisÃ©es vers le port 443
- [ ] Le serveur Debian (10.Y.1.20) est **inaccessible** depuis le Client VPN (avant connexion VPN)

:::tip[Checkpoint enseignant]
ğŸ‘¨â€ğŸ« Avant de continuer, faites valider votre configuration par l'enseignant.
Montrez-lui :
1. La liste des rÃ¨gles de filtrage dans le bon ordre
2. Les dÃ©tails des 3 rÃ¨gles VPN crÃ©Ã©es
3. Les logs montrant l'accÃ¨s au port 443 autorisÃ©
4. Un test nÃ©gatif (ping vers 10.Y.1.20 qui Ã©choue)
:::

---

## ğŸ¯ RÃ©sumÃ© de la Phase 4

Vous avez maintenant :

- âœ… Compris les 3 flux rÃ©seau nÃ©cessaires au VPN
- âœ… CrÃ©Ã© la zone de sÃ©curitÃ© VPN SSL (vpn_ssl)
- âœ… CrÃ©Ã© les 3 rÃ¨gles de filtrage essentielles :
  1. Autoriser connexions VPN entrantes (Internet â†’ SNS:443)
  2. Autoriser clients VPN vers rÃ©seau interne (vpn_ssl â†’ 10.Y.1.0/24)
  3. Autoriser rÃ©ponses (10.Y.1.0/24 â†’ vpn_ssl)
- âœ… OrganisÃ© les rÃ¨gles dans le bon ordre
- âœ… ActivÃ© les logs pour le suivi
- âœ… VÃ©rifiÃ© que le port 443 est accessible
- âœ… ConfirmÃ© que la sÃ©curitÃ© fonctionne (ressources internes bloquÃ©es sans VPN)

**ğŸ‰ Le serveur VPN est maintenant prÃªt Ã  accepter des connexions !**

**Prochaine Ã©tape** : Phase 5 - Installation et configuration du client VPN, puis connexion et tests

---

## ğŸ“š Pour aller plus loin (bonus)

### Bonus 1 : CrÃ©er des rÃ¨gles plus granulaires

Au lieu d'autoriser "any" pour les clients VPN vers l'interne, limitez aux services strictement nÃ©cessaires :

Modifiez la rÃ¨gle 2 :
- **Services autorisÃ©s** : CrÃ©er un groupe de services
  - HTTP (80)
  - HTTPS (443)
  - SSH (22)
  - SMB (445) - pour le partage de fichiers

Cela applique le **principe du moindre privilÃ¨ge**.

### Bonus 2 : CrÃ©er une rÃ¨gle de blocage explicite

Ajouter une rÃ¨gle juste aprÃ¨s les rÃ¨gles VPN :
- **Nom** : `Bloquer tout autre accÃ¨s depuis VPN`
- **Source** : vpn_ssl
- **Destination** : any
- **Action** : `Bloquer` (DENY)
- **Logs** : âœ… ActivÃ©s

Cela permet de logger toutes les tentatives d'accÃ¨s non autorisÃ©es depuis le VPN.

### Bonus 3 : Activer l'IPS sur le tunnel VPN

```
Configuration â†’ Politique de sÃ©curitÃ© â†’ PrÃ©vention d'intrusion (IPS)
```

CrÃ©er un profil IPS spÃ©cifique pour la zone vpn_ssl :
- Activer les signatures d'attaques rÃ©seau
- Activer les signatures d'exploits applicatifs
- Mode : PrÃ©vention (bloquer les attaques dÃ©tectÃ©es)

Associer ce profil Ã  la rÃ¨gle 2 (VPN clients vers rÃ©seau interne).

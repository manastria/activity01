---
title: Supervision et analyse du trafic réseau avec ntopng
description: Activité pratique de déploiement et configuration d'une solution de supervision réseau pour analyser le trafic traversant un firewall SNS.
---

## Contexte professionnel

**Entreprise :** DataFlow SARL (société de services informatiques, 45 employés)

**Situation :** Le responsable informatique a constaté des ralentissements réseau récurrents en fin de journée. La direction demande un rapport détaillé sur l'utilisation de la bande passante pour :

- Identifier les applications consommant le plus de ressources
- Détecter d'éventuels usages non professionnels
- Dimensionner correctement la bande passante pour l'année prochaine
- Préparer un audit de sécurité exigé par un nouveau client

**Mission des étudiants :** Déployer une solution de supervision réseau basée sur ntopng pour analyser le trafic traversant le firewall SNS et produire un rapport d'analyse.

## Objectifs pédagogiques

À l'issue de cette activité, les étudiants seront capables de :

- Comprendre l'intérêt d'un outil de supervision réseau dans un contexte professionnel
- Installer et configurer ntopng sur une VM Linux
- Configurer l'export IPFIX sur un firewall Stormshield SNS
- Analyser le trafic réseau et identifier les flux principaux
- Détecter des comportements réseau anormaux ou suspects
- Produire un rapport d'analyse pour la direction

## Architecture de la maquette

**Configuration requise par étudiant (1 machine physique) :**
```
                    Internet (réseau du labo 172.25.0.0/16)
                                   |
                              [SNS EVA1]
                         OUT: 172.25.X.254/16
                         IN:  192.168.X.254/24
                                   |
                    +--------------+---------------+
                    |                              |
              [Réseau LAN]                   Export IPFIX
           192.168.X.0/24                    UDP 4739
                    |                              |
        +-----------+-----------+                  ↓
        |           |           |            [VM ntopng]
   [VM Client1] [VM Client2]  ...        192.168.X.50
   192.168.X.10 192.168.X.11              - nProbe (collecte IPFIX)
                                          - ntopng (analyse web)
```

**Flux de données :**
1. Les VMs clientes → SNS → Internet (trafic normal)
2. SNS envoie une **copie** des métadonnées de flux → nProbe (IPFIX)
3. nProbe → ntopng (via ZMQ)
4. L'administrateur consulte ntopng via navigateur web

**Machines virtuelles nécessaires (sur 1 seul PC) :**

- SNS_EVA1 - firewall Stormshield SNS
- VM Debian 12 - pour ntopng
- 2 VMs Xubuntu - pour générer du trafic

## Prérequis

### Connaissances

- Configuration de base SNS (interfaces, filtrage, NAT)
- Commandes Linux de base
- Configuration réseau IP
- Notions de protocoles réseau (TCP/IP, HTTP, DNS, etc.)

### Matériel

- 1 ordinateur physique avec VirtualBox
- Minimum 8 Go RAM (12 Go recommandés)
- 80 Go d'espace disque disponible

### Fichiers fournis

- OVA SNS EVA1 (à récupérer et importer)
- OVA Debian 12 (à récupérer et importer)
- OVA VMs Xubuntu (à récupérer et importer)

## Durée estimée

- **Niveau normal :** 6 heures
- **Étudiants rapides :** Activités bonus disponibles (analyse avancée, alertes)

## PHASE 1 : Configuration du SNS
### Étape 1.1 : Import et configuration de base

1. Importez l'OVA _SNS EVA1_ dans _VirtualBox_. Les machines virtuelles « _**Debian-Training-Webmail**_ » et « **Graphical_client** » incluses dans le fichier OVA ne seront pas utilisées : elles peuvent être supprimées.

2. Renommer la VM en « **FW_IPFIX** »

3. Configurez les interfaces réseau de la VM _FW_IPFIX_ :
   - **Adapter 1** : Mode « _Bridged Adapter_ » (connexion Internet via le réseau du labo)
   - **Adapter 2** : Mode « _Internal Network_ » (nom : `LAN_IN_X` où X = votre numéro d'étudiant)

4. Démarrez la VM _SNS EVA1_ et effectuez la configuration initiale sans oublier le NAT (politique de sécurité n°10 « PASS ALL ») sortant avec les paramètres IP suivants :
   - **Interface OUT** : `172.25.X.254/16` (connexion vers le réseau du labo)
   - **Interface IN** : `192.168.X.254/24` (réseau LAN interne)

:::tip[Checkpoint 1]
Vérifiez la connectivité réseau depuis le _SNS_ :

- Testez la connectivité vers la passerelle du labo : `ping 172.25.254.254`
- Testez la connectivité vers Internet : `ping 8.8.8.8`
- Testez la résolution DNS : `nslookup www.google.com`

Les trois tests doivent réussir.
:::

### Étape 1.2 : Création des objets réseau

Avant de configurer le filtrage et le _NAT_ (_Network Address Translation_), créez les objets réseau nécessaires dans le _SNS_.

Allez dans **CONFIGURATION → OBJETS → OBJETS RÉSEAU** et créez les objets suivants :

| Nom de l'objet | Type | Valeur | Description |
|----------------|------|--------|-------------|
| `ntopng_vm` | Machine | `192.168.X.50` | VM Debian hébergeant ntopng et nProbe |
| `ssh_ntopng` | Port | TCP/22 | Accès SSH à la VM ntopng |
| `ssh_ntopng_nat` | Port | TCP/2222 | Accès SSH à la VM ntopng via les réseaux publiques |
| `web_ntopng` | Port | TCP/3000 | Interface web de ntopng |

:::tip[Checkpoint 2]
Prenez une capture d'écran montrant les trois objets créés dans la liste des objets réseau.
:::

### Étape 1.3 : Configuration du filtrage et du NAT

#### Configuration de la politique de filtrage

1. Allez dans **CONFIGURATION → POLITIQUE DE SÉCURITÉ → FILTRAGE ET NAT**

2. Vérifier que la politique de sécurité est bien « **(10) PASS ALL** » (autorisation temporaire pour la phase de test)

3. Cliquez sur **Appliquer** puis **Activer la politique**

:::caution[Attention]
Cette règle « **PASS ALL** » est **uniquement pour la phase de test**. Dans un contexte de production, il faut appliquer le principe de moindre privilège et n'autoriser que les flux strictement nécessaires.
:::

#### Configuration du NAT entrant

5. Créez deux règles de **NAT entrant** (_port forwarding_) pour permettre l'accès depuis le réseau du labo vers la VM ntopng :

**Règle 1 : Accès SSH**
- **Nom** : `NAT_SSH_ntopng`
- **Interface d'entrée** : `out`
- **Machine destination** : `Firewall_out`
- **Port destination** : `ssh_ntopng_nat`
- **Machine destination translatée** : `ntopng_vm`
- **Port destination translatée** : `ssh`

**Règle 2 : Accès interface web ntopng**
- **Nom** : `NAT_Web_ntopng`
- **Interface d'entrée** : `out`
- **Machine destination** : `Firewall_out`
- **Port destination** : `web_ntopng`
- **Machine destination translatée** : `ntopng_vm`
- **Port destination translatée** : `web_ntopng`

6. Cliquez sur **Appliquer** puis **Activer la politique**

:::tip[Checkpoint 3]
Prenez une capture d'écran montrant :
- La règle de filtrage « PASS ALL »
- Les deux règles de NAT entrant (SSH et Web)
:::




## PHASE 2 : Installation et configuration de ntopng

### Étape 2.1 : Déploiement de la VM ntopng

1. Récupérez l'OVA Debian 12 et importez-la dans VirtualBox
2. Configurez la VM avec les paramètres suivants :
   - **Nom** : `ntopng_superviseur`
   - **Réseau** : **Adapter 1** en "Internal Network" (nom : `LAN_IN_X` où X = votre numéro d'étudiant)
3. Démarrez la VM et connectez-vous (identifiants fournis par l'enseignant)
4. Configurez l'adresse IP de la VM : `192.168.X.50/24` avec comme passerelle et DNS `192.168.X.254`

:::tip[Checkpoint 1]
- La VM ntopng doit pouvoir joindre la passerelle SNS (192.168.X.254). Testez avec `ping`.
- La VM ntopng doit pouvoir joindre une machine sur internet (`ping`) et résoudre un nom de domaine publique (`dig`).
:::

### Étape 2.2 : Installation de ntopng et nProbe

:::note[Pourquoi ntopng ?]
ntopng est un outil open-source de monitoring réseau qui permet d'analyser en temps réel le trafic réseau. Contrairement à la simple consultation des logs du firewall, ntopng offre une vue graphique, des statistiques détaillées et une analyse comportementale du réseau.
:::

#### Préparation du système

1. Mettez à jour le système et installez les dépendances :
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. Installer les dépendances :

   ```bash
   sudo apt install wget gnupg software-properties-common -y
   ```

#### Ajout du dépôt officiel ntop

3. Téléchargez le paquet de configuration du dépôt ntop :
   ```bash
   wget https://packages.ntop.org/apt/bookworm/all/apt-ntop.deb
   ```

4. Installez le paquet téléchargé :
   ```bash
   sudo dpkg -i apt-ntop.deb
   ```

5. Mettez à jour la liste des paquets :
   ```bash
   sudo apt update
   ```

#### Installation de ntopng et nprobe

6. Installez ntopng, nProbe et leurs dépendances (Redis sera installé automatiquement) :
   ```bash
   sudo apt install ntopng ntopng-data nprobe -y
   ```

   :::note[Rôle de nProbe]
   Dans la version Community, ntopng ne collecte pas directement les flux NetFlow/IPFIX reçus en UDP.
   nProbe joue le rôle de **collecteur de flux** (UDP 4739 par exemple) et les expose ensuite à ntopng via ZMQ.
   :::

   :::note[nProbe Community vs Professional]
   **nProbe Community** (gratuit) est suffisant pour ce TP. Il permet de :
   - Collecter des flux IPFIX/NetFlow
   - Les transmettre à ntopng via ZMQ
   - Gérer les templates IPFIX basiques

   **nProbe Professional** (payant) offre des fonctionnalités avancées :
   - Export des flux vers plusieurs collecteurs
   - DPI (Deep Packet Inspection) pour identifier les applications chiffrées
   - Agrégation de flux multiples
   - Support de protocoles propriétaires

   Pour un usage en production, évaluez vos besoins avant de choisir la version.
   :::

#### Sauvegarde des fichiers de configuration

7. Avant toute modification, sauvegardez les fichiers de configuration :
   ```bash
   sudo cp -a /etc/ntopng/ntopng.conf /etc/ntopng/ntopng.conf.bak.$(date +%F)
   sudo cp -a /etc/nprobe/nprobe.conf /etc/nprobe/nprobe.conf.bak.$(date +%F)
   ```

### Étape 2.3 : Configuration de nProbe (collecte IPFIX/NetFlow)

1. Éditez le fichier de configuration de nProbe :
   ```bash
   sudo nano /etc/nprobe/nprobe.conf
   ```

   Remplacez le contenu par une configuration minimale :
   ```text
   # Collecte des flux reçus du firewall (IPFIX/NetFlow) sur UDP/4739
   --collector-port=4739

   # Exposition des flux vers ntopng via ZMQ (ntopng se connecte sur ce port)
   --zmq=tcp://*:5556

   # Template recommandé pour une bonne compatibilité avec ntopng
   -T=@NTOPNG@
   ```

   :::note[Port de collecte IPFIX]
   Dans ce TP, le firewall SNS exporte les flux en IPFIX vers le port UDP **4739**.
   Si vous utilisez un autre port (ex. 2055), adaptez `--collector-port` et la règle de filtrage côté SNS.
   :::

### Étape 2.4 : Configuration de ntopng

1. Éditez le fichier de configuration :
```bash
sudo nano /etc/ntopng/ntopng.conf
```

Ajoutez/modifiez les lignes suivantes :
```text
-G=/var/run/ntopng.pid
--http-port=3000
--community
--disable-login=1
# Interface de flux fournie par nProbe (ZMQ)
-i=tcp://127.0.0.1:5556
```

**Explications :**

- `--collector-port=4739` (nProbe) : nProbe écoute les flux IPFIX/NetFlow envoyés par le firewall sur le port UDP 4739.
- `--zmq=tcp://*:5556` (nProbe) : nProbe met à disposition une interface ZMQ.
- `-i=tcp://127.0.0.1:5556` (ntopng) : ntopng se connecte à nProbe pour afficher les flux.

:::caution[Sécurité en production]
Dans un environnement de production, il ne faut **jamais** désactiver l'authentification. Cette option n'est utilisée ici que dans un cadre pédagogique sur un réseau isolé.
:::

### Étape 2.5 : Démarrage des services

1. Activez et démarrez les services Redis, nProbe et ntopng :
```bash
sudo systemctl enable redis-server
sudo systemctl start redis-server

sudo systemctl enable nprobe
sudo systemctl start nprobe

sudo systemctl enable ntopng
sudo systemctl start ntopng
```

2. Vérifiez le statut des services :
```bash
sudo systemctl status redis-server --no-pager
sudo systemctl status nprobe --no-pager
sudo systemctl status ntopng --no-pager
```

:::tip[Checkpoint 2]
Les trois services doivent être actifs (running). Prenez une capture d'écran du résultat de `systemctl status ntopng`.
:::

### Étape 2.6 : Vérification de l'installation

1. Vérifiez que nProbe et ntopng sont bien installés et écoutent sur les bons ports :
```bash
# Vérifier les versions installées
nprobe --version
ntopng --version

# Vérifier que nProbe écoute sur le port 4739 (après démarrage)
sudo ss -ulnp | grep 4739

# Vérifier que nProbe expose ZMQ sur le port 5556
sudo ss -ltnp | grep 5556

# Vérifier que ntopng écoute sur le port 3000
sudo ss -ltnp | grep 3000
```

:::note[Comportement de ZMQ et sockets UDP]
Il est possible que la commande `ss` ne montre pas les ports 5556 (ZMQ) et 4739 (UDP IPFIX) selon la façon dont nProbe configure ses sockets. Ce comportement est normal. Si les services sont **actifs** (`systemctl status`) et que l'interface web ntopng affiche une interface ZMQ, tout fonctionne correctement.

Pour vérifier manuellement la réception de flux IPFIX, utilisez :
```bash
sudo tcpdump -ni any udp port 4739 -c 5
```
:::

**Résultats attendus :**
```text
# nProbe écoute UDP 4739 pour collecter IPFIX
UNCONN 0 0 0.0.0.0:4739 0.0.0.0:* users:(("nprobe",pid=XXXX,fd=X))

# nProbe expose ZMQ sur TCP 5556
LISTEN 0 128 0.0.0.0:5556 0.0.0.0:* users:(("nprobe",pid=XXXX,fd=X))

# ntopng interface web sur TCP 3000
LISTEN 0 128 0.0.0.0:3000 0.0.0.0:* users:(("ntopng",pid=XXXX,fd=X))
```

:::tip[Checkpoint 3]
Si les trois ports sont bien en écoute, l'installation est correcte. Prenez une capture d'écran des résultats.
:::

### Étape 2.7 : Accès à l'interface web

1. Depuis une VM Xubuntu cliente, ouvrez un navigateur
2. Accédez à : `http://192.168.X.50:3000`
3. L'interface ntopng doit s'afficher

:::tip[Checkpoint 4]
Prenez une capture d'écran de la page d'accueil de ntopng (qui sera encore vide pour l'instant).
:::

## PHASE 3 : Configuration du firewall SNS pour l'export IPFIX

### Étape 3.1 : Activation de l'export IPFIX sur SNS

:::note[Qu'est-ce que IPFIX ?]
NetFlow (Cisco) et IPFIX (standard IETF) permettent d'exporter des **informations sur les flux réseau** vers un collecteur (ici, nProbe). Au lieu d'analyser chaque paquet, le firewall envoie des résumés de connexions (qui parle à qui, sur quel port, combien de données, etc.).
:::

1. Connectez-vous à l'interface web du SNS EVA1 depuis une VM cliente : `https://192.168.X.254`
2. Naviguez vers **CONFIGURATION → NOTIFICATIONS → TRACES - SYSLOG - IPFIX**
3. Cliquez sur l'onglet **IPFIX**
4. Configuration IPFIX :
   - État : **Activé**
   - Version : **IPFIX** (recommandé pour ce TP)
   - Collecteur 1 :
     - Adresse IP : `ntopng_vm`
     - Port : `4739` (port utilisé par nProbe dans ce TP)
5. Cliquez sur **Appliquer**

:::tip[Checkpoint 5]
Prenez une capture d'écran de la configuration d'export de flux IPFIX.
:::

### Étape 3.2 : Activation de l'exportation des flux sur les règles de filtrage

Pour que le SNS (_Stormshield Network Security_) alimente ntopng, la configuration du collecteur (adresse IP et port) est une condition nécessaire, mais insuffisante. L'exportation des données doit être activée manuellement sur les règles de filtrage pertinentes.

#### Manipulation

Dans la politique de sécurité du firewall, pour chaque règle devant être supervisée :

1. Éditez la règle de filtrage
2. Allez dans l'onglet **« Action »**, puis dans la section **« Configuration avancée »**
3. Cochez la case **« Collecteur IPFIX »** (Internet Protocol Flow Information Export)
4. **Appliquez** la politique de sécurité pour rendre la modification effective

:::tip[Checkpoint 6]
Prenez une capture d'écran montrant une règle de filtrage avec la case « Collecteur IPFIX » cochée.
:::

#### Pourquoi cette étape est-elle indispensable ?

* **Sélectivité des données :** Le SNS n'exporte pas l'intégralité du trafic par défaut afin de ne pas saturer le lien réseau vers le collecteur avec des flux inutiles (ex: broadcast, flux techniques internes).
* **Optimisation des performances :** La génération de paquets IPFIX consomme des ressources CPU. En activant l'option uniquement sur des règles spécifiques (ex: accès Internet, zones sensibles), on préserve les performances du moteur de filtrage.
* **Génération des métadonnées :** C'est cette case qui ordonne au pare-feu d'extraire les métadonnées du flux (IP source/destination, ports, drapeaux TCP, volume) pour les encapsuler dans un datagramme UDP à destination de ntopng.

:::caution[Rappel pédagogique]
Si un flux traverse le pare-feu mais n'apparaît pas dans ntopng, le premier réflexe est de vérifier si la case « Collecteur IPFIX » est bien cochée dans l'ACL (Access Control List) correspondante.
:::

## PHASE 4 : Génération de trafic et analyse

### Étape 4.1 : Génération de trafic varié

**Objectif :** Simuler différents types d'utilisation réseau pour que ntopng ait des données à analyser, en utilisant les ressources disponibles sur le réseau du laboratoire.

:::caution[Attention à la bande passante]
Le réseau du laboratoire est partagé par tous les étudiants. Évitez les téléchargements massifs simultanés qui satureraient la connexion Internet. Privilégiez les ressources locales (serveur du labo, torrents locaux).
:::

**Répartition des tâches sur les 2 VMs Xubuntu :**

#### Sur VM Xubuntu Client 1 (192.168.X.10)

**Navigation web légère (10 minutes) :**
- Visitez plusieurs sites : Wikipedia, sites d'actualités
- Ouvrez 5-6 onglets simultanément
- Consultez votre messagerie web (Gmail, Outlook.com)
- **Évitez** les téléchargements volumineux depuis Internet

**Services locaux du laboratoire :**
- Si un serveur FTP/HTTP est disponible sur le réseau du labo (`172.25.X.X`), téléchargez quelques fichiers de test (50-100 Mo)
- Utilisez les services réseau mis à disposition par l'enseignant

**Streaming vidéo modéré :**
- Regardez **une seule** vidéo YouTube de 2-3 minutes

#### Sur VM Xubuntu Client 2 (192.168.X.11)

**Téléchargement BitTorrent (local) :**
- Connectez-vous au tracker BitTorrent du laboratoire (si disponible)
- Téléchargez une distribution Linux hébergée localement (Ubuntu/Debian ISO)

**Trafic DNS intensif :**
- Naviguez sur de nombreux sites différents (Wikipedia, sites universitaires)
- Utilisez `nslookup` pour faire des requêtes DNS variées :
```bash
for domain in wikipedia.org github.com stackoverflow.com gnu.org debian.org ubuntu.com; do
  nslookup $domain
  sleep 1
done
```

**Accès aux serveurs du labo :**
- Si un serveur web est disponible sur `172.25.X.X`, effectuez plusieurs requêtes HTTP
- Testez les différents services réseau mis à disposition

#### Utilisation des ressources communes

**Serveur de simulation du laboratoire** (si configuré par l'enseignant) :

Si un serveur Docker/VM est disponible sur le réseau du labo (`172.25.X.Y`), utilisez-le pour :
- Télécharger des fichiers de test de tailles variées (1 Mo, 10 Mo, 50 Mo)
- Tester différents protocoles (HTTP, FTP, SSH)
- Générer du trafic contrôlé sans saturer la connexion Internet

**Commandes de test depuis les VMs clientes :**
```bash
# Test HTTP vers serveur du labo (adapter l'IP)
for i in {1..20}; do
  curl -o /dev/null http://172.25.X.Y/testfile_10M.bin
done

# Test FTP vers serveur du labo
wget ftp://172.25.X.Y/fichier_test.iso

# Génération de trafic DNS
for i in {1..50}; do
  dig @172.25.254.15 site$i.example.com
done
```

:::tip[Checkpoint 7]
Laissez tourner ce trafic pendant **15-20 minutes** pour accumuler suffisamment de données.

**Bonnes pratiques :**
- Évitez les téléchargements simultanés de tous les étudiants
- Si le réseau devient lent, réduisez votre trafic
- Privilégiez les ressources locales du laboratoire
- Alternez les activités entre les binômes
:::

### Étape 4.2 : Analyse dans ntopng

Connectez-vous à l'interface ntopng depuis une VM cliente pour analyser les résultats.

#### Vue d'ensemble du trafic

1. Accédez à **Dashboard**
2. Observez le graphique de bande passante en temps réel
3. Notez les débits maximum observés

**Questions de réflexion :**

- À quel moment le trafic a-t-il été le plus élevé ?
- Quelle VM a généré le plus de trafic ?

#### Analyse des hôtes

1. Cliquez sur **Hosts → Hosts**
2. Identifiez les deux VMs clientes (`192.168.X.10` et `192.168.X.11`)
3. Cliquez sur chaque hôte pour voir le détail :
   - Volume de données envoyées/reçues
   - Nombre de flux
   - Ports utilisés

**Tableau à compléter dans votre rapport :**

| Hôte         | Volume envoyé | Volume reçu | Top 3 des ports utilisés | Observation |
| ------------ | ------------- | ----------- | ------------------------ | ----------- |
| 192.168.X.10 |               |             |                          |             |
| 192.168.X.11 |               |             |                          |             |

#### Analyse des flux

1. Cliquez sur **Flows → Flows**
2. Triez par "Bytes" pour voir les flux les plus volumineux
3. Identifiez :
   - Les connexions vers des sites de streaming (port 443, gros volume)
   - Les téléchargements (connexions longues avec transfert important)
   - La navigation web classique (nombreuses petites connexions)

:::tip[Checkpoint 8]
Prenez 5-6 captures d'écran montrant :
- Le dashboard global
- Le détail des deux hôtes
- La liste des flux triés par volume
- La répartition des protocoles (HTTP/HTTPS/DNS/etc.)
:::

### Étape 4.3 : Analyse des applications

1. Allez dans **Applications**
2. ntopng catégorise automatiquement le trafic par type d'application

**Questions d'analyse :**

- Quelle application a consommé le plus de bande passante ?
- Quelle proportion représente le streaming vidéo par rapport au total ?
- Y a-t-il des applications inattendues ou suspectes ?

:::tip[Checkpoint 9]
Complétez un tableau récapitulatif :

| Catégorie d'application | Pourcentage du trafic | Volume de données | Commentaire |
| ----------------------- | --------------------- | ----------------- | ----------- |
| Streaming vidéo         |                       |                   |             |
| Navigation web          |                       |                   |             |
| Téléchargements         |                       |                   |             |
| DNS                     |                       |                   |             |
| Autres                  |                       |                   |             |
:::

## PHASE 5 : Détection d'anomalies

### Étape 5.1 : Simulation de comportements anormaux

**Objectif :** Apprendre à détecter des usages réseau problématiques.

#### Scénario 1 : Scan de ports

1. Sur une VM Xubuntu cliente, installez nmap :
```bash
sudo apt install nmap
```

2. Lancez un scan de ports sur le réseau LAN :
```bash
nmap -sS 192.168.X.0/24
```

3. Dans ntopng, allez dans **Alerts**
4. Observez si une alerte de scan de ports a été générée

#### Scénario 2 : Trafic P2P excessif (simulation)

Si vous avez un client BitTorrent :

1. Téléchargez un fichier Linux via BitTorrent
2. Observez dans ntopng :
   - Le nombre important de connexions simultanées
   - Les ports non standard utilisés
   - Le volume de trafic généré

#### Scénario 3 : Connexion DNS anormale

1. Générez des requêtes DNS massives :
```bash
for i in {1..100}; do nslookup site$i.example.com; done
```

2. Vérifiez dans ntopng si ce comportement est visible dans les statistiques DNS

:::tip[Checkpoint 10]
Pour chaque scénario, prenez une capture d'écran montrant l'anomalie détectée et expliquez comment vous l'avez identifiée.
:::

### Étape 5.2 : Analyse comportementale

**Questions de réflexion :**

1. Quels indicateurs permettent de différencier :
   - Une utilisation normale d'Internet ?
   - Un téléchargement massif de fichiers ?
   - Un comportement potentiellement malveillant (scan, exfiltration de données) ?

2. Quelles limites voyez-vous à ntopng ?
   - Peut-il voir le contenu des flux chiffrés (HTTPS) ?
   - Comment pourrait-on compléter cette supervision ?

3. Dans un contexte d'entreprise réel :
   - Combien de temps devrait-on conserver les données ntopng ?
   - Qui devrait y avoir accès ?
   - Quelles règles éthiques et légales faut-il respecter (RGPD) ?

## PHASE 6 : Production du rapport d'analyse

### Livrable à rendre

Rédigez un rapport professionnel structuré en 3-4 pages comprenant :

#### 1. Page de garde

- Nom de l'entreprise (DataFlow SARL)
- Titre : "Audit de supervision réseau - Analyse du trafic"
- Date et nom de l'étudiant

#### 2. Synthèse exécutive (1/2 page)

Résumez en langage non technique pour la direction :

- L'objectif de la mission
- Les principaux constats
- Les recommandations clés

#### 3. Présentation de la solution technique (1 page)

- Architecture mise en place (schéma)
- Outils utilisés (SNS + ntopng)
- Période d'observation

#### 4. Résultats de l'analyse (1 à 1,5 page)

- Statistiques globales (volume total, pic de trafic, répartition par hôte)
- Répartition par application/protocole (avec graphiques)
- Identification des consommateurs principaux de bande passante
- Détection d'anomalies (si pertinent)

#### 5. Recommandations (1/2 page)

Proposez 3-4 recommandations concrètes :

- Optimisation de la bande passante
- Mise en place de règles de QoS si nécessaire
- Sensibilisation des utilisateurs
- Amélioration de la politique de sécurité

#### 6. Annexes

- Captures d'écran clés
- Tableaux de données détaillés

## Activités bonus (pour les étudiants rapides)

### Bonus 1 : Mise en place d'alertes

Configurez ntopng pour envoyer des alertes par email ou syslog lorsque :

- Un hôte dépasse un seuil de bande passante (ex: 100 Mbps)
- Un scan de ports est détecté
- Une connexion suspecte est établie

### Bonus 2 : Corrélation SNS + ntopng

Comparez les logs du firewall SNS avec les données ntopng :

- Retrouvez dans ntopng les connexions bloquées par SNS
- Identifiez des flux autorisés par SNS mais suspects selon ntopng

### Bonus 3 : Export et archivage

- Exportez les données ntopng au format CSV
- Créez des graphiques dans LibreOffice Calc pour le rapport
- Réfléchissez à une politique d'archivage des données de supervision

## Annexe : Vérifications et dépannage (enseignant)

Cette annexe regroupe les commandes utiles pour diagnostiquer rapidement un problème de collecte de flux.

### 1) Statut des services
```bash
sudo systemctl status redis-server --no-pager
sudo systemctl status nprobe --no-pager
sudo systemctl status ntopng --no-pager
```

### 2) Logs (les erreurs de configuration sont souvent explicites)
```bash
sudo journalctl -u nprobe -n 200 --no-pager
sudo journalctl -u ntopng -n 200 --no-pager
```

### 3) Vérifier les ports (écoute et connexions)
```bash
# nProbe doit écouter en UDP sur le port de collecte (ici 4739)
sudo ss -lunp | grep 4739

# nProbe doit exposer ZMQ (ici 5556) et ntopng doit pouvoir s'y connecter
sudo ss -ltnp | grep 5556
```

### 4) Vérifier l'arrivée des flux côté Debian
```bash
# Voir si le firewall envoie bien des paquets vers le collecteur
sudo tcpdump -ni any udp port 4739
```

### 5) Vérifier la cohérence configuration nProbe/ntopng
```bash
sudo grep -E "collector-port|zmq|@NTOPNG@" /etc/nprobe/nprobe.conf
sudo grep -E "^-i=|--http-port|--community|--disable-login" /etc/ntopng/ntopng.conf
```

### 6) Symptômes fréquents

- **Paquets visibles avec tcpdump, mais aucun trafic dans ntopng** :
  - vérifier que nProbe écoute bien sur le bon port UDP (`ss -lunp | grep 4739`)
  - vérifier que ntopng pointe sur le bon endpoint ZMQ (`-i=tcp://127.0.0.1:5556`)
  - vérifier les logs nProbe/ntopng (erreur ZMQ, option inconnue, etc.)
- **Interface ntopng vide (pas d'interface ZMQ)** :
  - vérifier que nProbe expose bien ZMQ (`ss -ltnp | grep 5556`)
  - vérifier un éventuel pare-feu local (rare sur VM de TP)

### 7) Scénarios de dépannage courants

#### Scénario A : nProbe ne démarre pas

**Symptôme :** `sudo systemctl status nprobe` montre "failed"

**Diagnostic :**
```bash
sudo journalctl -u nprobe -n 50 --no-pager
```

**Causes fréquentes :**
- Port 4739 déjà utilisé par un autre processus
- Erreur de syntaxe dans `/etc/nprobe/nprobe.conf`
- Problème de permissions

**Solution :**
```bash
# Vérifier si le port est occupé
sudo ss -ulnp | grep 4739

# Tester la configuration manuellement
sudo nprobe --collector-port=4739 --zmq=tcp://*:5556 -T=@NTOPNG@
# Si erreur → corriger la config
```

#### Scénario B : ntopng ne voit aucune interface ZMQ

**Symptôme :** Interface ntopng vide, aucun trafic visible

**Diagnostic :**
```bash
# Vérifier que nProbe expose bien ZMQ
sudo ss -ltnp | grep 5556

# Vérifier la config ntopng
grep "^-i=" /etc/ntopng/ntopng.conf
```

**Causes fréquentes :**
- nProbe n'a pas démarré correctement
- Configuration ZMQ incorrecte dans ntopng.conf
- Mauvaise syntaxe : `-i=tcp://127.0.0.1:5556` (correct) vs `-i=tcp://localhost:5556` (parfois problématique)

**Solution :**
```bash
# Redémarrer dans l'ordre
sudo systemctl restart nprobe
sleep 5
sudo systemctl restart ntopng
```

#### Scénario C : Flux IPFIX reçus mais pas affichés dans ntopng

**Symptôme :** `tcpdump` montre des paquets UDP 4739, mais ntopng reste vide

**Diagnostic :**
```bash
# Vérifier que nProbe reçoit et traite les flux
sudo journalctl -u nprobe -f
# On doit voir : "Received X flow packets"

# Vérifier que ntopng se connecte à ZMQ
sudo journalctl -u ntopng -f
# On doit voir : "ZMQ interface tcp://127.0.0.1:5556"
```

**Causes fréquentes :**
- Template IPFIX non reconnu par nProbe
- Version incompatible nProbe/ntopng
- Problème de décodage des flux

**Solution :**
```bash
# Vérifier la version de nProbe et ntopng
nprobe --version
ntopng --version

# Forcer le template NTOPNG dans nProbe
sudo nano /etc/nprobe/nprobe.conf
# S'assurer que -T=@NTOPNG@ est présent
```

## Annexe : Préparation du serveur de simulation (enseignant)

Pour permettre aux étudiants de générer du trafic sans saturer la connexion Internet, vous pouvez déployer un serveur de test sur le réseau du laboratoire.

### Option 1 : Serveur web simple avec Nginx (VM ou Docker)

**VM Debian/Ubuntu sur le réseau du labo (ex: 172.25.100.50) :**
```bash
# Installation Nginx
sudo apt update && sudo apt install nginx -y

# Création de fichiers de test de différentes tailles
cd /var/www/html
sudo dd if=/dev/urandom of=testfile_1M.bin bs=1M count=1
sudo dd if=/dev/urandom of=testfile_10M.bin bs=1M count=10
sudo dd if=/dev/urandom of=testfile_50M.bin bs=1M count=50
sudo dd if=/dev/urandom of=testfile_100M.bin bs=1M count=100

# Page d'accueil simple
echo "<html><body><h1>Serveur de test - Labo BTS SIO</h1>
<ul>
  <li><a href='testfile_1M.bin'>Fichier 1 Mo</a></li>
  <li><a href='testfile_10M.bin'>Fichier 10 Mo</a></li>
  <li><a href='testfile_50M.bin'>Fichier 50 Mo</a></li>
  <li><a href='testfile_100M.bin'>Fichier 100 Mo</a></li>
</ul></body></html>" | sudo tee /var/www/html/index.html
```

**Les étudiants pourront alors :**
```bash
# Télécharger depuis leurs VMs clientes
wget http://172.25.100.50/testfile_10M.bin
curl -o /dev/null http://172.25.100.50/testfile_50M.bin
```

### Option 2 : Serveur FTP
```bash
# Installation vsftpd
sudo apt install vsftpd -y

# Configuration basique
sudo nano /etc/vsftpd.conf
# Décommenter : anonymous_enable=YES

# Créer des fichiers dans /srv/ftp
sudo mkdir -p /srv/ftp
cd /srv/ftp
sudo dd if=/dev/urandom of=debian.iso bs=1M count=500
```

### Option 3 : Container Docker multi-services
```yaml
# Docker Compose avec Nginx + FTP + serveur de fichiers
version: '3'
services:
  webserver:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./files:/usr/share/nginx/html
  ftpserver:
    image: fauria/vsftpd
    ports:
      - "20:20"
      - "21:21"
      - "21100-21110:21100-21110"
    environment:
      FTP_USER: student
      FTP_PASS: student
      PASV_ADDRESS: 172.25.100.50
```

### Tracker BitTorrent local (recommandé)

Utilisez le tracker BitTorrent déjà existant sur le réseau du labo avec des fichiers ISO Linux pré-seedés.

**Avantages :**
- Génère beaucoup de connexions simultanées (bon pour l'analyse ntopng)
- Consomme la bande passante localement (pas sur Internet)
- Simule du trafic P2P réaliste

**Fichiers à proposer :**
- Ubuntu 24.04 LTS (ISO ~4 Go)
- Debian 12 (ISO ~3 Go)
- Fichiers de test plus petits (100-500 Mo)

### Planification des téléchargements

Pour éviter la saturation du réseau :

**Planning suggéré :**
- **Binômes 1-5** : Génération de trafic de 14h00 à 14h20
- **Binômes 6-10** : Génération de trafic de 14h25 à 14h45
- **Binômes 11-15** : Génération de trafic de 14h50 à 15h10

Ou bien :
- Alternance : pendant qu'un binôme génère du trafic lourd, les autres font de l'analyse

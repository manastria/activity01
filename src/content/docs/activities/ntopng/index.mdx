---
title: Supervision et analyse du trafic réseau avec ntopng
description: Activité pratique de déploiement et configuration d'une solution de supervision réseau pour analyser le trafic traversant un firewall SNS.
---

## Contexte professionnel

**Entreprise :** DataFlow SARL (société de services informatiques, 45 employés)

**Situation :** Le responsable informatique a constaté des ralentissements réseau récurrents en fin de journée. La direction demande un rapport détaillé sur l'utilisation de la bande passante pour :

- Identifier les applications consommant le plus de ressources
- Détecter d'éventuels usages non professionnels
- Dimensionner correctement la bande passante pour l'année prochaine
- Préparer un audit de sécurité exigé par un nouveau client

**Mission des étudiants :** Déployer une solution de supervision réseau basée sur ntopng pour analyser le trafic traversant le firewall SNS et produire un rapport d'analyse.

## Objectifs pédagogiques

À l'issue de cette activité, les étudiants seront capables de :

- Comprendre l'intérêt d'un outil de supervision réseau dans un contexte professionnel
- Installer et configurer ntopng sur une VM Linux
- Configurer l'export NetFlow sur un firewall Stormshield SNS
- Analyser le trafic réseau et identifier les flux principaux
- Détecter des comportements réseau anormaux ou suspects
- Produire un rapport d'analyse pour la direction

## Architecture de la maquette

**Configuration requise par étudiant (1 machine physique) :**
```
Internet simulé (OUT: 172.25.0.0/16)
         |
    [SNS EVA1]
    OUT: 172.25.X.254
    IN:  192.168.X.254
         |
         | NetFlow (UDP 2055)
         |
    [Réseau LAN]──────────────────────────> [VM ntopng]
    192.168.X.0/24                          192.168.X.50
         |
    +----+----+
    |         |
[VM Client 1] [VM Client 2]
(Xubuntu)     (Xubuntu)
192.168.X.10  192.168.X.11
```

**Machines virtuelles nécessaires (sur 1 seul PC) :**

- SNS_EVA1 - firewall Stormshield SNS
- VM Debian 12 - pour ntopng
- 2 VMs Xubuntu - pour générer du trafic

## Prérequis

### Connaissances

- Configuration de base SNS (interfaces, filtrage, NAT)
- Commandes Linux de base
- Configuration réseau IP
- Notions de protocoles réseau (TCP/IP, HTTP, DNS, etc.)

### Matériel

- 1 ordinateur physique avec VirtualBox
- Minimum 8 Go RAM (12 Go recommandés)
- 80 Go d'espace disque disponible

### Fichiers fournis

- OVA SNS EVA1 (à récupérer et importer)
- OVA Debian 12 (à récupérer et importer)
- OVA VMs Xubuntu (à récupérer et importer)

## Durée estimée

- **Niveau normal :** 6 heures
- **Étudiants rapides :** Activités bonus disponibles (analyse avancée, alertes)

## PHASE 0 : Configuration du SNS.
1. Importez l'OVA SNS EVA1 dans VirtualBox
2. Configurez les interfaces réseau :
   - Carte 1 : Mode "Bridged Adapter" (connexion Internet simulée)
   - Carte 2 : Mode "Internal Network" (nom : `LAN_IN_X` où X = votre numéro d'étudiant)
3. Configuration initiale du SNS EVA1 avec la configuration IP suivante :
   - OUT : 172.25.X.254/16 (simule la connexion Internet)
   - IN : 192.168.X.254/24 (réseau LAN interne)

## PHASE 1 : Installation et configuration de ntopng

### Étape 1.1 : Déploiement de la VM ntopng

1. Récupérez l'OVA Debian 12 et importez-la dans VirtualBox
2. Configurez la VM avec les paramètres suivants :
   - Nom : `ntopng_superviseur`
   - RAM : 2 Go minimum
   - CPU : 2 cœurs
   - Réseau : Carte 1 en "Internal Network" (nom : `LAN_IN_X` où X = votre numéro d'étudiant)

3. Démarrez la VM et connectez-vous (identifiants fournis par l'enseignant)
4. Configurez l'adresse IP de la VM : `192.168.X.50/24` avec comme passerelle `192.168.X.254`

:::tip[Checkpoint 1]
La VM ntopng doit pouvoir joindre la passerelle SNS (192.168.X.254). Testez avec `ping`.
:::

### Étape 1.2 : Installation de ntopng

:::note[Pourquoi ntopng ?]
ntopng est un outil open-source de monitoring réseau qui permet d'analyser en temps réel le trafic réseau. Contrairement à la simple consultation des logs du firewall, ntopng offre une vue graphique, des statistiques détaillées et une analyse comportementale du réseau.
:::

#### Préparation du système

1. Mettez à jour le système et installez les dépendances :
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install wget gnupg software-properties-common -y
```

#### Ajout du dépôt officiel ntop

2. Téléchargez et installez le paquet de configuration du dépôt ntop :
```bash
wget https://packages.ntop.org/apt/bookworm/all/apt-ntop.deb
sudo dpkg -i apt-ntop.deb
```

3. Mettez à jour la liste des paquets :
```bash
sudo apt update
```

#### Installation de ntopng

4. Installez ntopng et ses dépendances (Redis sera installé automatiquement) :
```bash
sudo apt install ntopng ntopng-data -y
```

#### Configuration de ntopng

5. Éditez le fichier de configuration :
```bash
sudo nano /etc/ntopng/ntopng.conf
```

Ajoutez/modifiez les lignes suivantes :
```text
-i=none
--http-port=3000
--community
--disable-login=1
```

**Explications :**

- `-i=none` : ntopng n'écoute pas directement une interface mais attend des flux NetFlow
- `--http-port=3000` : interface web accessible sur le port 3000
- `--community` : version communautaire (gratuite)
- `--disable-login=1` : désactive l'authentification (pour simplifier le TP)

:::caution[Attention]
Dans un environnement de production, il ne faut **jamais** désactiver l'authentification. Cette option n'est utilisée ici que dans un cadre pédagogique sur un réseau isolé.
:::

#### Démarrage des services

6. Activez et démarrez les services Redis et ntopng :
```bash
sudo systemctl enable redis-server
sudo systemctl start redis-server
sudo systemctl enable ntopng
sudo systemctl start ntopng
```

7. Vérifiez le statut du service :
```bash
sudo systemctl status ntopng
```

:::tip[Checkpoint 2]
Le service ntopng doit être actif (running). Prenez une capture d'écran du résultat de `systemctl status ntopng`.
:::

### Étape 1.3 : Accès à l'interface web

1. Depuis une VM Xubuntu cliente, ouvrez un navigateur
2. Accédez à : `http://192.168.X.50:3000`
3. L'interface ntopng doit s'afficher

:::tip[Checkpoint 3]
Prenez une capture d'écran de la page d'accueil de ntopng (qui sera encore vide pour l'instant).
:::

## PHASE 2 : Configuration du firewall SNS pour l'export NetFlow

### Étape 2.1 : Activation de NetFlow sur SNS

:::note[Qu'est-ce que NetFlow ?]
NetFlow est un protocole développé par Cisco qui permet d'exporter des informations sur les flux réseau vers un collecteur (ici, ntopng). Au lieu d'analyser chaque paquet, NetFlow envoie des résumés de connexions (qui parle à qui, sur quel port, combien de données, etc.).
:::

1. Connectez-vous à l'interface web du SNS EVA1 depuis une VM cliente : `https://192.168.X.254`
2. Allez dans **CONFIGURATION → SYSTÈME → CONFIGURATION**
3. Dans l'onglet **NetFlow**, activez l'export :
   - État : **Activé**
   - Version NetFlow : **v5** (la plus compatible)
   - Collecteur 1 :
     - Adresse IP : `192.168.X.50`
     - Port : `2055` (port par défaut NetFlow)
   - Interfaces à exporter : Cochez **"out"** et **"in"** (pour capturer le trafic entrant et sortant)

4. Cliquez sur **Appliquer**

:::tip[Checkpoint 4]
Prenez une capture d'écran de la configuration NetFlow.
:::

### Étape 2.2 : Création d'une règle de filtrage pour NetFlow

Pour que SNS puisse envoyer les données à ntopng, il faut autoriser ce flux dans le firewall.

1. Allez dans **CONFIGURATION → POLITIQUE DE SÉCURITÉ → FILTRAGE ET NAT**
2. Créez une nouvelle règle (avant la règle de blocage par défaut) :
   - Nom : `Autoriser_NetFlow_vers_ntopng`
   - Source : `Firewall_in`
   - Destination : Créez un objet "ntopng_server" avec l'IP `192.168.X.50`
   - Service : `UDP 2055`
   - Action : **PASS**
   - Logs : Niveau normal

3. Cliquez sur **Appliquer** puis **Activer**

:::tip[Checkpoint 5]
Vérifiez dans **MONITORING → LOGS** que des connexions NetFlow apparaissent vers `192.168.X.50:2055`.
:::

## PHASE 3 : Génération de trafic et analyse

### Étape 3.1 : Génération de trafic varié

**Objectif :** Simuler différents types d'utilisation réseau pour que ntopng ait des données à analyser.

**Répartition des tâches sur les 2 VMs Xubuntu :**

#### Sur VM Xubuntu Client 1 (192.168.X.10)

**Navigation web classique (10 minutes) :**

- Visitez plusieurs sites : sites d'actualités, Wikipedia, sites professionnels
- Ouvrez plusieurs onglets simultanément
- Téléchargez quelques fichiers PDF (5-10 Mo chacun)

**Utilisation de services en ligne :**

- Consultez votre messagerie web (Gmail, Outlook.com)
- Regardez une vidéo YouTube (2-3 minutes)

**Transferts de fichiers :**

- Si un serveur FTP est disponible en DMZ, téléchargez un fichier volumineux
- Sinon, téléchargez une distribution Linux ISO (Ubuntu/Debian)

#### Sur VM Xubuntu Client 2 (192.168.X.11)

**Streaming vidéo (15 minutes) :**

- Lancez plusieurs vidéos YouTube en qualité HD
- Utilisez des services de streaming (si accessible)

**Téléchargements simultanés :**

- Téléchargez plusieurs fichiers volumineux en même temps
- Utilisez des sites de partage de fichiers

**Trafic DNS intensif :**

- Naviguez sur de nombreux sites différents rapidement
- Utilisez des outils comme `nslookup` pour faire des requêtes DNS variées

:::tip[Checkpoint 6]
Laissez tourner ce trafic pendant 15-20 minutes pour accumuler des données.
:::

### Étape 3.2 : Analyse dans ntopng

Connectez-vous à l'interface ntopng depuis une VM cliente pour analyser les résultats.

#### Vue d'ensemble du trafic

1. Accédez à **Dashboard**
2. Observez le graphique de bande passante en temps réel
3. Notez les débits maximum observés

**Questions de réflexion :**

- À quel moment le trafic a-t-il été le plus élevé ?
- Quelle VM a généré le plus de trafic ?

#### Analyse des hôtes

1. Cliquez sur **Hosts → Hosts**
2. Identifiez les deux VMs clientes (`192.168.X.10` et `192.168.X.11`)
3. Cliquez sur chaque hôte pour voir le détail :
   - Volume de données envoyées/reçues
   - Nombre de flux
   - Ports utilisés

**Tableau à compléter dans votre rapport :**

| Hôte         | Volume envoyé | Volume reçu | Top 3 des ports utilisés | Observation |
| ------------ | ------------- | ----------- | ------------------------ | ----------- |
| 192.168.X.10 |               |             |                          |             |
| 192.168.X.11 |               |             |                          |             |

#### Analyse des flux

1. Cliquez sur **Flows → Flows**
2. Triez par "Bytes" pour voir les flux les plus volumineux
3. Identifiez :
   - Les connexions vers des sites de streaming (port 443, gros volume)
   - Les téléchargements (connexions longues avec transfert important)
   - La navigation web classique (nombreuses petites connexions)

:::tip[Checkpoint 7]
Prenez 5-6 captures d'écran montrant :
- Le dashboard global
- Le détail des deux hôtes
- La liste des flux triés par volume
- La répartition des protocoles (HTTP/HTTPS/DNS/etc.)
:::

### Étape 3.3 : Analyse des applications

1. Allez dans **Applications**
2. ntopng catégorise automatiquement le trafic par type d'application

**Questions d'analyse :**

- Quelle application a consommé le plus de bande passante ?
- Quelle proportion représente le streaming vidéo par rapport au total ?
- Y a-t-il des applications inattendues ou suspectes ?

:::tip[Checkpoint 8]
Complétez un tableau récapitulatif :

| Catégorie d'application | Pourcentage du trafic | Volume de données | Commentaire |
| ----------------------- | --------------------- | ----------------- | ----------- |
| Streaming vidéo         |                       |                   |             |
| Navigation web          |                       |                   |             |
| Téléchargements         |                       |                   |             |
| DNS                     |                       |                   |             |
| Autres                  |                       |                   |             |
:::

## PHASE 4 : Détection d'anomalies

### Étape 4.1 : Simulation de comportements anormaux

**Objectif :** Apprendre à détecter des usages réseau problématiques.

#### Scénario 1 : Scan de ports

1. Sur une VM Xubuntu cliente, installez nmap :
```bash
sudo apt install nmap
```

2. Lancez un scan de ports sur le réseau LAN :
```bash
nmap -sS 192.168.X.0/24
```

3. Dans ntopng, allez dans **Alerts**
4. Observez si une alerte de scan de ports a été générée

#### Scénario 2 : Trafic P2P excessif (simulation)

Si vous avez un client BitTorrent :

1. Téléchargez un fichier Linux via BitTorrent
2. Observez dans ntopng :
   - Le nombre important de connexions simultanées
   - Les ports non standard utilisés
   - Le volume de trafic généré

#### Scénario 3 : Connexion DNS anormale

1. Générez des requêtes DNS massives :
```bash
for i in {1..100}; do nslookup site$i.example.com; done
```

2. Vérifiez dans ntopng si ce comportement est visible dans les statistiques DNS

:::tip[Checkpoint 9]
Pour chaque scénario, prenez une capture d'écran montrant l'anomalie détectée et expliquez comment vous l'avez identifiée.
:::

### Étape 4.2 : Analyse comportementale

**Questions de réflexion :**

1. Quels indicateurs permettent de différencier :
   - Une utilisation normale d'Internet ?
   - Un téléchargement massif de fichiers ?
   - Un comportement potentiellement malveillant (scan, exfiltration de données) ?

2. Quelles limites voyez-vous à ntopng ?
   - Peut-il voir le contenu des flux chiffrés (HTTPS) ?
   - Comment pourrait-on compléter cette supervision ?

3. Dans un contexte d'entreprise réel :
   - Combien de temps devrait-on conserver les données ntopng ?
   - Qui devrait y avoir accès ?
   - Quelles règles éthiques et légales faut-il respecter (RGPD) ?

## PHASE 5 : Production du rapport d'analyse

### Livrable à rendre

Rédigez un rapport professionnel structuré en 3-4 pages comprenant :

#### 1. Page de garde

- Nom de l'entreprise (DataFlow SARL)
- Titre : "Audit de supervision réseau - Analyse du trafic"
- Date et nom de l'étudiant

#### 2. Synthèse exécutive (1/2 page)

Résumez en langage non technique pour la direction :

- L'objectif de la mission
- Les principaux constats
- Les recommandations clés

#### 3. Présentation de la solution technique (1 page)

- Architecture mise en place (schéma)
- Outils utilisés (SNS + ntopng)
- Période d'observation

#### 4. Résultats de l'analyse (1 à 1,5 page)

- Statistiques globales (volume total, pic de trafic, répartition par hôte)
- Répartition par application/protocole (avec graphiques)
- Identification des consommateurs principaux de bande passante
- Détection d'anomalies (si pertinent)

#### 5. Recommandations (1/2 page)

Proposez 3-4 recommandations concrètes :

- Optimisation de la bande passante
- Mise en place de règles de QoS si nécessaire
- Sensibilisation des utilisateurs
- Amélioration de la politique de sécurité

#### 6. Annexes

- Captures d'écran clés
- Tableaux de données détaillés

## Activités bonus (pour les étudiants rapides)

### Bonus 1 : Mise en place d'alertes

Configurez ntopng pour envoyer des alertes par email ou syslog lorsque :

- Un hôte dépasse un seuil de bande passante (ex: 100 Mbps)
- Un scan de ports est détecté
- Une connexion suspecte est établie

### Bonus 2 : Corrélation SNS + ntopng

Comparez les logs du firewall SNS avec les données ntopng :

- Retrouvez dans ntopng les connexions bloquées par SNS
- Identifiez des flux autorisés par SNS mais suspects selon ntopng

### Bonus 3 : Export et archivage

- Exportez les données ntopng au format CSV
- Créez des graphiques dans LibreOffice Calc pour le rapport
- Réfléchissez à une politique d'archivage des données de supervision
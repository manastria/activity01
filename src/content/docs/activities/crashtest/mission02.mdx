---
title: Mission 2 - Configuration de la DMZ
description: Mise en place d'une architecture r√©seau s√©curis√©e avec pare-feu et zones de s√©curit√©
---

import { Steps, Card, CardGrid, Aside } from '@astrojs/starlight/components';

# Mission 2 : Configuration de la DMZ

## Objectif

Configurer une architecture r√©seau s√©curis√©e avec pare-feu Stormshield pour isoler les services GLPI dans une zone d√©militaris√©e (_DMZ_).

<CardGrid>
  <Card title="Difficult√©" icon="star">
    Moyen üë®‚Äçüíª
  </Card>
  <Card title="Temps estim√©" icon="clock">
    4 heures
  </Card>
</CardGrid>

## Pr√©requis

- Avoir termin√© la Mission 1 (GLPI fonctionnel)
- Disposer de la VM Stormshield SNS EVA 1 (v4.3.2)
- Acc√®s au r√©seau du laboratoire (172.25.0.0/16)
- Ma√Ætriser les bases des r√©seaux (IP, masque, passerelle, NAT)

## Contexte

Le CRASH dispose actuellement d'une infrastructure r√©seau peu s√©curis√©e o√π tous les services sont accessibles sans filtrage. Les serveurs GLPI, qui doivent √™tre accessibles depuis Internet pour les associations, se trouvent dans le m√™me r√©seau que les postes administratifs internes.

Cette situation pr√©sente des **risques majeurs** :
- Un serveur GLPI compromis pourrait attaquer directement le r√©seau interne
- Aucun filtrage des flux r√©seau entrants/sortants
- Impossibilit√© de tracer les connexions suspectes
- Non-conformit√© avec les bonnes pratiques de s√©curit√©

**Votre mission** : Cr√©er une architecture en zones de s√©curit√© avec un pare-feu nouvelle g√©n√©ration (_NGFW_ - _Next Generation Firewall_) qui isole les serveurs publics dans une DMZ.

:::tip[Approche p√©dagogique]
Cette mission propose trois niveaux de r√©alisation :
- ‚≠ê Architecture de base avec r√®gles de pare-feu essentielles
- ‚≠ê‚≠ê S√©curisation avanc√©e avec IPS et logs centralis√©s
- ‚≠ê‚≠ê‚≠ê Fonctionnalit√©s professionnelles et audit de s√©curit√©

Chaque niveau inclut le pr√©c√©dent. Visez au minimum le niveau ‚≠ê pour valider la mission.
:::

## Architecture cible

### Vue d'ensemble
```
Internet Labo (172.25.0.0/16)
         |
         | Bridge eno1
         |
    [EVA1 - fw-crash]
     ‚îú‚îÄ eth0 (OUT) ‚Üí 172.25.x.y/16
     ‚îú‚îÄ eth1 (DMZ) ‚Üí 10.54.0.1/24
     ‚îî‚îÄ eth2 (IN)  ‚Üí 172.17.0.1/16
         |
         ‚îú‚îÄ [glpi-srv01] ‚Üí 10.54.0.10/24 (DMZ)
         ‚îî‚îÄ [admin-poste] ‚Üí 172.17.0.100/16 (LAN)
```

:::note[Architecture modulaire (Mission 1 - Niveau 3)]
Si vous avez s√©par√© les services web et base de donn√©es en Mission 1 (‚≠ê‚≠ê‚≠ê), votre architecture comprendra deux serveurs en DMZ :
- **glpi-web01** : 10.54.0.10/24 (serveur web + PHP)
- **glpi-db01** : 10.54.0.11/24 (base de donn√©es)

Les r√®gles de pare-feu devront √™tre adapt√©es en cons√©quence pour autoriser la communication entre ces deux serveurs.
:::

### Zones de s√©curit√© d√©finies

| Zone | Interface | R√©seau | Passerelle | Niveau de confiance |
|------|-----------|--------|------------|---------------------|
| **OUT** | eth0 | 172.25.x.y/16 | 172.25.0.1 | ‚ùå Non fiable (Internet) |
| **DMZ** | eth1 | 10.54.0.0/24 | 10.54.0.1 (EVA1) | ‚ö†Ô∏è Partiellement fiable |
| **IN** (LAN) | eth2 | 172.17.0.0/16 | 172.17.0.1 (EVA1) | ‚úÖ Fiable (r√©seau interne) |

### Plan d'adressage

#### Pare-feu EVA1 (`fw-crash`)

| Interface | IP | Masque | R√¥le |
|-----------|-----|--------|------|
| eth0 (OUT) | 172.25.x.y | 255.255.0.0 | Vers Internet labo |
| eth1 (DMZ) | 10.54.0.1 | 255.255.255.0 | Passerelle DMZ |
| eth2 (IN) | 172.17.0.1 | 255.255.0.0 | Passerelle LAN |

:::note[Adresse IP OUT]
L'adresse IP de l'interface OUT (eth0) vous sera attribu√©e par votre formateur. Elle correspond √† votre num√©ro d'√©tudiant dans la plage 172.25.x.y/16.
:::

#### Serveurs et postes

| Nom | IP | Zone | Usage |
|-----|-----|------|-------|
| **glpi-srv01** | 10.54.0.10 | DMZ | Serveur GLPI complet |
| **admin-poste** | 172.17.0.100 | LAN | Poste d'administration |

**Si architecture modulaire (Mission 1 ‚≠ê‚≠ê‚≠ê) :**

| Nom | IP | Zone | Usage |
|-----|-----|------|-------|
| **glpi-web01** | 10.54.0.10 | DMZ | Serveur web + PHP |
| **glpi-db01** | 10.54.0.11 | DMZ | Base de donn√©es |
| **admin-poste** | 172.17.0.100 | LAN | Poste d'administration |

---

## Matrice de flux r√©seau

Cette matrice d√©finit **qui peut communiquer avec qui** et **sur quels services**.

| Source | Destination | Services autoris√©s | Justification |
|--------|-------------|-------------------|---------------|
| **Internet** ‚Üí **DMZ** | HTTPS (443) vers 10.54.0.10 | Acc√®s public au portail GLPI |
| **LAN** ‚Üí **DMZ** | HTTPS (443), SSH (22), MySQL (3306)* | Administration des serveurs |
| **LAN** ‚Üí **Internet** | HTTP (80), HTTPS (443), DNS (53), NTP (123), SSH (22) | Navigation, mises √† jour, admin distante |
| **DMZ** ‚Üí **Internet** | HTTP (80), HTTPS (443), DNS (53), NTP (123) | Mises √† jour syst√®me |
| **DMZ** ‚Üí **DMZ** | MySQL (3306)* | Communication web ‚Üí base de donn√©es |
| **DMZ** ‚Üí **LAN** | ‚ùå **INTERDIT** | Isolation : un serveur compromis ne doit pas attaquer le LAN |
| **Internet** ‚Üí **LAN** | ‚ùå **INTERDIT** | Pas d'acc√®s direct depuis l'ext√©rieur |

_* MySQL (3306) : uniquement si architecture modulaire avec glpi-web01 et glpi-db01 s√©par√©s_

---

## T√¢ches √† r√©aliser

### T√¢che 1 ‚≠ê : Pr√©paration de l'environnement VirtualBox

Avant de configurer le pare-feu, vous devez cr√©er l'infrastructure r√©seau dans VirtualBox.

#### √âtape 1.1 : Cr√©ation des r√©seaux internes VirtualBox

<Steps>

1. Ouvrez VirtualBox et allez dans **Fichier > Gestionnaire de r√©seau h√¥te**

2. Cr√©ez deux r√©seaux internes :
   - **R√©seau 1** : Nommez-le `vboxnet-dmz`
     - Ne pas activer le serveur DHCP
     - Ne pas configurer d'adaptateur sur l'h√¥te (pas d'IP)
   - **R√©seau 2** : Nommez-le `vboxnet-lan`
     - Ne pas activer le serveur DHCP
     - Ne pas configurer d'adaptateur sur l'h√¥te (pas d'IP)

</Steps>

:::tip[Pourquoi pas de DHCP ?]
Les serveurs et le pare-feu utilisent des IP fixes. Le DHCP n'est pas n√©cessaire et pourrait cr√©er des conflits d'adressage.
:::

#### √âtape 1.2 : Configuration r√©seau de la VM EVA1

Configurez **3 adaptateurs r√©seau** pour la VM `fw-crash` (Stormshield EVA1) :

| Adaptateur | Type | Attach√© √† | Nom/Interface |
|------------|------|-----------|---------------|
| **Adapter 1** | Bridged Adapter | `eno1` | Interface physique du labo |
| **Adapter 2** | Internal Network | `vboxnet-dmz` | R√©seau interne DMZ |
| **Adapter 3** | Internal Network | `vboxnet-lan` | R√©seau interne LAN |

<Aside type="caution">
V√©rifiez que le mode **promiscuous** est sur ¬´ Refuser ¬ª pour chaque adaptateur (param√®tre par d√©faut).
</Aside>

#### √âtape 1.3 : Configuration r√©seau de la VM GLPI

**Si architecture monolithique (Mission 1 ‚≠ê ou ‚≠ê‚≠ê) :**

Configurez **1 adaptateur r√©seau** pour la VM `glpi-srv01` :

| Adaptateur | Type | Attach√© √† |
|------------|------|-----------|
| **Adapter 1** | Internal Network | `vboxnet-dmz` |

**Si architecture modulaire (Mission 1 ‚≠ê‚≠ê‚≠ê) :**

Configurez **1 adaptateur r√©seau** pour chaque VM :

- **glpi-web01** : Internal Network ‚Üí `vboxnet-dmz`
- **glpi-db01** : Internal Network ‚Üí `vboxnet-dmz`

#### √âtape 1.4 : Configuration r√©seau du poste admin

Cr√©ez une VM minimale (Debian ou XUbuntu) nomm√©e `admin-poste` avec :

| Adaptateur | Type | Attach√© √† |
|------------|------|-----------|
| **Adapter 1** | Internal Network | `vboxnet-lan` |

Cette VM servira √† tester les acc√®s depuis le LAN.

---

### T√¢che 2 ‚≠ê : Configuration initiale de l'EVA1

D√©marrez la VM `fw-crash` et effectuez la configuration de base.

#### √âtape 2.1 : Premi√®re connexion

<Steps>

1. D√©marrez la VM Stormshield EVA1

2. Connectez-vous avec les identifiants par d√©faut :
   - **Login** : `admin`
   - **Password** : `admin`

3. Vous √™tes invit√© √† changer le mot de passe ‚Üí Choisissez un mot de passe robuste et documentez-le

</Steps>

#### √âtape 2.2 : Configuration des interfaces r√©seau

Acc√©dez √† l'interface web de Stormshield :

<Steps>

1. **Identifiez l'IP de l'interface OUT** (eth0) :
   ```bash
      # En CLI sur EVA1
      show configuration network
   ```

2. Depuis un navigateur sur votre h√¥te, acc√©dez √† : `https://172.25.x.y` (remplacez par votre IP)

3. Connectez-vous avec `admin` et votre nouveau mot de passe

4. Allez dans **Configuration > R√©seau > Interfaces**

5. Configurez les 3 interfaces :

</Steps>

**Interface OUT (eth0) :**
```
Nom : OUT
Type : Ethernet
IPv4 : 172.25.x.y/16 (votre IP attribu√©e)
Passerelle : 172.25.0.1
Zone de s√©curit√© : Internet
```

**Interface DMZ (eth1) :**
```
Nom : DMZ
Type : Ethernet
IPv4 : 10.54.0.1/24
Passerelle : (vide)
Zone de s√©curit√© : DMZ
```

**Interface IN (eth2) :**
```
Nom : IN
Type : Ethernet
IPv4 : 172.17.0.1/16
Passerelle : (vide)
Zone de s√©curit√© : Internal
```

<Steps>

6. **Activez le routage** : Configuration > R√©seau > Routage > Activer le routage IPv4

7. **Appliquez la configuration** et red√©marrez l'EVA1 si n√©cessaire

</Steps>

#### √âtape 2.3 : V√©rification de la connectivit√©

Depuis l'EVA1 (CLI ou interface web), testez :
```bash
# Ping vers Internet
ping -c 3 8.8.8.8

# Ping vers la passerelle labo
ping -c 3 172.25.0.1
```

Si les pings √©chouent, v√©rifiez la configuration r√©seau de l'interface OUT.

---

### T√¢che 3 ‚≠ê : Configuration r√©seau des serveurs GLPI

Configurez les adresses IP et passerelles sur vos serveurs GLPI.

#### Configuration de `glpi-srv01` (architecture monolithique)

Connectez-vous √† la VM et configurez l'interface r√©seau :

**Avec Netplan (Ubuntu/Debian r√©cent) :**
```yaml
# /etc/netplan/01-netcfg.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.54.0.10/24
      routes:
        - to: default
          via: 10.54.0.1
      nameservers:
        addresses:
          - 172.17.0.1
          - 8.8.8.8
```
```bash
sudo netplan apply
```

**Avec interfaces classiques (Debian ancien) :**
```bash
# /etc/network/interfaces
auto eth0
iface eth0 inet static
    address 10.54.0.10
    netmask 255.255.255.0
    gateway 10.54.0.1
    dns-nameservers 172.17.0.1 8.8.8.8
```
```bash
sudo systemctl restart networking
```

#### Configuration architecture modulaire (si Mission 1 ‚≠ê‚≠ê‚≠ê)

**Sur `glpi-web01` :**
- IP : 10.54.0.10/24
- Passerelle : 10.54.0.1
- DNS : 172.17.0.1, 8.8.8.8

**Sur `glpi-db01` :**
- IP : 10.54.0.11/24
- Passerelle : 10.54.0.1
- DNS : 172.17.0.1, 8.8.8.8

#### V√©rification

Testez la connectivit√© depuis `glpi-srv01` (ou glpi-web01) :
```bash
# Ping vers la passerelle (EVA1)
ping -c 3 10.54.0.1

# Ping vers Internet (devrait √©chouer pour l'instant, pas de r√®gles pare-feu)
ping -c 3 8.8.8.8
```

---

### T√¢che 4 ‚≠ê : Configuration r√©seau du poste admin

Configurez l'adresse IP du poste d'administration dans le LAN.

**Sur `admin-poste` :**
- IP : 172.17.0.100/16
- Passerelle : 172.17.0.1 (EVA1)
- DNS : 172.17.0.1, 8.8.8.8

Testez la connectivit√© :
```bash
# Ping vers la passerelle
ping -c 3 172.17.0.1

# Ping vers Internet (devrait √©chouer, pas de r√®gles encore)
ping -c 3 8.8.8.8
```

---

### T√¢che 5 ‚≠ê : Cr√©ation des objets r√©seau dans Stormshield

Avant de cr√©er les r√®gles de pare-feu, d√©finissez des objets r√©seau r√©utilisables.

Dans l'interface web EVA1 : **Configuration > Objets > R√©seau**

<Steps>

1. **Cr√©ez les objets r√©seaux :**

   | Nom | Type | Valeur | Description |
   |-----|------|--------|-------------|
   | `net_lan` | R√©seau | 172.17.0.0/16 | R√©seau interne CRASH |
   | `net_dmz` | R√©seau | 10.54.0.0/24 | Zone d√©militaris√©e |
   | `host_glpi_srv01` | H√¥te | 10.54.0.10 | Serveur GLPI |
   | `host_admin_poste` | H√¥te | 172.17.0.100 | Poste administration |

2. **Si architecture modulaire, ajoutez :**

   | Nom | Type | Valeur | Description |
   |-----|------|--------|-------------|
   | `host_glpi_web01` | H√¥te | 10.54.0.10 | Serveur web GLPI |
   | `host_glpi_db01` | H√¥te | 10.54.0.11 | Base de donn√©es GLPI |

3. **Cr√©ez des groupes de services (optionnel mais recommand√©) :**

</Steps>

**Configuration > Objets > Protocoles et services**

| Nom | Type | Ports | Description |
|-----|------|-------|-------------|
| `srv_web_standard` | Groupe | HTTP (80), HTTPS (443) | Services web |
| `srv_administration` | Groupe | SSH (22) | Administration serveurs |
| `srv_updates` | Groupe | HTTP, HTTPS, DNS (53), NTP (123) | Mises √† jour syst√®me |

---

### T√¢che 6 ‚≠ê : Configuration des r√®gles de pare-feu de base

Cr√©ez la politique de filtrage dans **Configuration > Pare-feu > R√®gles de filtrage**.

:::caution[Ordre des r√®gles]
L'ordre des r√®gles est **CRUCIAL**. Stormshield applique les r√®gles de haut en bas et s'arr√™te √† la premi√®re correspondance. Placez les r√®gles sp√©cifiques avant les r√®gles g√©n√©rales.
:::

#### R√®gle 1 : Anti-spoofing

Prot√©gez contre les attaques de _spoofing_ (usurpation d'adresse IP).

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `Anti-spoof OUT` |
| **Source** | Interface OUT, Adresse IP : `net_lan` OU `net_dmz` |
| **Destination** | Any |
| **Service** | Any |
| **Action** | **BLOCK** |
| **Log** | Alarm |

**Justification** : Bloque les paquets venant d'Internet (OUT) mais pr√©tendant provenir du LAN ou de la DMZ.

---

#### R√®gle 2 : Acc√®s public GLPI (Internet ‚Üí DMZ)

Autorisez l'acc√®s externe au portail GLPI.

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `Internet vers GLPI` |
| **Source** | Interface OUT, Adresse : Any |
| **Destination** | `host_glpi_srv01` (10.54.0.10) |
| **Service** | HTTPS (443) |
| **Action** | **PASS** |
| **Log** | Log |
| **NAT** | Activer (voir T√¢che 7) |

**Justification** : Seul service accessible depuis Internet : le portail GLPI en HTTPS.

---

#### R√®gle 3 : Administration depuis le LAN (LAN ‚Üí DMZ)

Autorisez les administrateurs √† g√©rer les serveurs DMZ.

**R√®gle 3a : Acc√®s HTTPS**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `LAN vers GLPI HTTPS` |
| **Source** | `net_lan` |
| **Destination** | `host_glpi_srv01` |
| **Service** | HTTPS (443) |
| **Action** | **PASS** |
| **Log** | Log |

**R√®gle 3b : Acc√®s SSH**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `LAN vers GLPI SSH` |
| **Source** | `net_lan` |
| **Destination** | `host_glpi_srv01` |
| **Service** | SSH (22) |
| **Action** | **PASS** |
| **Log** | Log |

**R√®gle 3c : Acc√®s MySQL (architecture modulaire uniquement)**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `LAN vers MySQL` |
| **Source** | `net_lan` |
| **Destination** | `host_glpi_db01` |
| **Service** | MySQL (3306) |
| **Action** | **PASS** |
| **Log** | Log |

**Justification** : Les administrateurs doivent pouvoir g√©rer les serveurs (consultation GLPI, SSH pour maintenance, acc√®s BDD pour debug).

---

#### R√®gle 4 : Navigation Internet depuis le LAN (LAN ‚Üí Internet)

Autorisez les utilisateurs du LAN √† acc√©der √† Internet.

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `LAN vers Internet` |
| **Source** | `net_lan` |
| **Destination** | Interface OUT, Adresse : Any |
| **Service** | `srv_updates` (HTTP, HTTPS, DNS, NTP) + SSH |
| **Action** | **PASS** |
| **Log** | Log (HTTP/HTTPS uniquement) |
| **NAT** | Activer (voir T√¢che 7) |

**Justification** : Navigation web, mises √† jour, administration distante pour les utilisateurs internes.

---

#### R√®gle 5 : Mises √† jour depuis la DMZ (DMZ ‚Üí Internet)

Autorisez les serveurs DMZ √† se mettre √† jour.

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `DMZ vers Internet (updates)` |
| **Source** | `net_dmz` |
| **Destination** | Interface OUT, Adresse : Any |
| **Service** | `srv_updates` (HTTP, HTTPS, DNS, NTP) |
| **Action** | **PASS** |
| **Log** | Log |
| **NAT** | Activer (voir T√¢che 7) |

**Justification** : Les serveurs doivent pouvoir t√©l√©charger les mises √† jour de s√©curit√© et synchroniser l'heure.

---

#### R√®gle 6 : Communication inter-serveurs DMZ (architecture modulaire)

**Uniquement si vous avez s√©par√© web et base de donn√©es (Mission 1 ‚≠ê‚≠ê‚≠ê).**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `GLPI Web vers DB` |
| **Source** | `host_glpi_web01` |
| **Destination** | `host_glpi_db01` |
| **Service** | MySQL (3306) |
| **Action** | **PASS** |
| **Log** | - (pas de log, trop verbeux) |

**Justification** : Le serveur web doit pouvoir interroger la base de donn√©es.

---

#### R√®gle 7 : BLOCAGE DMZ ‚Üí LAN (**CRITIQUE**)

**LA r√®gle de s√©curit√© la plus importante** : emp√™cher un serveur compromis d'attaquer le LAN.

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `DMZ vers LAN INTERDIT` |
| **Source** | `net_dmz` |
| **Destination** | `net_lan` |
| **Service** | Any |
| **Action** | **BLOCK** |
| **Log** | **Alarm** (alerte de s√©curit√©) |

**Justification** : Isolation totale. Si un serveur DMZ est pirat√©, il ne doit JAMAIS pouvoir acc√©der au r√©seau interne.

---

#### R√®gle 8 : BLOCAGE Internet ‚Üí LAN

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `Internet vers LAN INTERDIT` |
| **Source** | Interface OUT |
| **Destination** | `net_lan` |
| **Service** | Any |
| **Action** | **BLOCK** |
| **Log** | Alarm |

**Justification** : Aucun acc√®s direct depuis Internet vers le r√©seau interne.

---

#### R√®gle implicite : Deny All

Stormshield poss√®de une r√®gle implicite en fin de politique : **tout ce qui n'est pas explicitement autoris√© est bloqu√©**.

V√©rifiez que cette r√®gle est active : **Configuration > Pare-feu > R√®gles de filtrage > R√®gle implicite : Block & Log**.

---

### T√¢che 7 ‚≠ê : Configuration du NAT/PAT

Configurez la traduction d'adresses pour permettre aux r√©seaux priv√©s d'acc√©der √† Internet.

#### NAT sortant (PAT - Port Address Translation)

**Configuration > Pare-feu > NAT**

<Steps>

1. Cr√©ez une r√®gle de NAT sortant pour le LAN :

   | Param√®tre | Valeur |
   |-----------|--------|
   | **Nom** | `NAT LAN sortant` |
   | **Source** | `net_lan` (172.17.0.0/16) |
   | **Destination** | Any |
   | **IP traduite** | Adresse de l'interface OUT (172.25.x.y) |
   | **Type** | Dynamic NAT (PAT) |

2. Cr√©ez une r√®gle de NAT sortant pour la DMZ :

   | Param√®tre | Valeur |
   |-----------|--------|
   | **Nom** | `NAT DMZ sortant` |
   | **Source** | `net_dmz` (10.54.0.0/24) |
   | **Destination** | Any |
   | **IP traduite** | Adresse de l'interface OUT (172.25.x.y) |
   | **Type** | Dynamic NAT (PAT) |

</Steps>

**Justification** : Permet aux machines avec des IP priv√©es (10.x et 172.17.x) de sortir sur Internet via l'IP publique du pare-feu.

---

#### NAT entrant (DNAT - Destination NAT)

Redirigez les connexions HTTPS entrantes vers le serveur GLPI.

<Steps>

3. Cr√©ez une r√®gle de NAT entrant (DNAT) :

   | Param√®tre | Valeur |
   |-----------|--------|
   | **Nom** | `DNAT HTTPS vers GLPI` |
   | **Interface entrante** | OUT |
   | **IP destination** | 172.25.x.y (IP publique de l'EVA1) |
   | **Port destination** | 443 |
   | **IP traduite** | 10.54.0.10 (`host_glpi_srv01`) |
   | **Port traduit** | 443 |

4. **Liez cette r√®gle NAT √† la r√®gle de filtrage n¬∞2** (`Internet vers GLPI`)

</Steps>

**Justification** : Quand quelqu'un acc√®de √† `https://172.25.x.y` depuis Internet, la requ√™te est automatiquement redirig√©e vers le serveur GLPI en DMZ.

---

### T√¢che 8 ‚≠ê : Tests de connectivit√© et validation

V√©rifiez que votre architecture fonctionne correctement.

#### Test 1 : LAN ‚Üí Internet

Depuis `admin-poste` :
```bash
# Test DNS
nslookup google.com

# Test HTTP
curl -I http://www.debian.org

# Test HTTPS
curl -I https://www.debian.org
```

‚úÖ **Attendu** : Toutes les commandes fonctionnent.

---

#### Test 2 : DMZ ‚Üí Internet

Depuis `glpi-srv01` :
```bash
# Test de mise √† jour
sudo apt update

# Test NTP
ntpdate -q pool.ntp.org

# Test ping (devrait fonctionner si ICMP autoris√©)
ping -c 3 8.8.8.8
```

‚úÖ **Attendu** : Les mises √† jour fonctionnent, NTP r√©pond.

---

#### Test 3 : LAN ‚Üí DMZ (administration)

Depuis `admin-poste` :
```bash
# Test HTTPS vers GLPI
curl -k https://10.54.0.10

# Test SSH
ssh user@10.54.0.10
```

‚úÖ **Attendu** : GLPI r√©pond, SSH fonctionne.

---

#### Test 4 : Internet ‚Üí DMZ (acc√®s public)

Depuis votre machine h√¥te ou un autre poste du labo :
```bash
# Acc√®s au portail GLPI
curl -k https://172.25.x.y
```

Ou dans un navigateur : `https://172.25.x.y`

‚úÖ **Attendu** : La page d'accueil de GLPI s'affiche.

---

#### Test 5 : DMZ ‚Üí LAN (doit √©chouer !)

Depuis `glpi-srv01` :
```bash
# Tentative de ping vers le LAN
ping -c 3 172.17.0.100

# Tentative de SSH vers le LAN
ssh user@172.17.0.100
```

‚ùå **Attendu** : **Toutes les tentatives √©chouent** (timeout). V√©rifiez les logs EVA1 : une alarme doit √™tre lev√©e.

---

#### Test 6 : V√©rification des logs

Dans l'interface web EVA1 : **Monitoring > Logs > Filtrage**

Recherchez les √©v√©nements r√©cents :
- ‚úÖ Connexions autoris√©es (r√®gles PASS) apparaissent en vert
- ‚ùå Connexions bloqu√©es (r√®gles BLOCK) apparaissent en rouge avec alarme

**V√©rifiez particuli√®rement** que la tentative DMZ ‚Üí LAN (Test 5) a bien g√©n√©r√© une alarme.

---

### T√¢che 9 ‚≠ê‚≠ê : Activation de l'IPS (Intrusion Prevention System)

Activez la d√©tection et le blocage automatique des attaques.

#### Configuration de l'IPS

**Configuration > S√©curit√© > IPS**

<Steps>

1. **Activez l'IPS** : Cochez ¬´ Activer l'IPS ¬ª

2. **Configurez les profils IPS par interface :**

   | Interface | Profil IPS | Justification |
   |-----------|-----------|---------------|
   | **OUT ‚Üí DMZ** | ¬´ Serveur Web ¬ª | D√©tecte attaques web (SQL injection, XSS, scan de vuln√©rabilit√©s) |
   | **LAN ‚Üí OUT** | ¬´ Poste client ¬ª | D√©tecte malware, C&C (_Command & Control_), exfiltration de donn√©es |
   | **LAN ‚Üí DMZ** | ¬´ Poste client ¬ª | D√©tecte attaques internes |

3. **Mode IPS** : S√©lectionnez ¬´ Pr√©vention ¬ª (pas juste d√©tection)

4. **Sensibilit√©** : Moyenne (compromis entre s√©curit√© et faux positifs)

5. **Appliquez** la configuration

</Steps>

---

#### Test de l'IPS

Depuis un poste externe au labo, lancez un scan de vuln√©rabilit√©s sur votre serveur GLPI :
```bash
# Avec Nmap (scan de ports agressif)
nmap -A -T4 172.25.x.y

# Avec Nikto (scan de vuln√©rabilit√©s web)
nikto -h https://172.25.x.y
```

**V√©rifiez dans les logs EVA1** (**Monitoring > Logs > IPS**) :
- ‚úÖ Le scan doit √™tre d√©tect√©
- ‚úÖ Des alertes IPS doivent √™tre lev√©es
- ‚úÖ Certaines connexions doivent √™tre bloqu√©es

**Documentez** les alertes IPS g√©n√©r√©es et expliquez leur signification.

---

### T√¢che 10 ‚≠ê‚≠ê : Centralisation des logs vers Syslog

Envoyez les logs du pare-feu vers le serveur Syslog centralis√© (docker_logs de la Mission 1).

#### Configuration de l'envoi Syslog

**Configuration > Notifications > Syslog**

<Steps>

1. **Activez l'envoi Syslog**

2. **Configurez le serveur Syslog distant :**

   | Param√®tre | Valeur |
   |-----------|--------|
   | **Adresse IP** | IP de votre conteneur Syslog (ex: 172.17.0.20) |
   | **Port** | 514 |
   | **Protocole** | UDP |
   | **Facility** | Local0 |
   | **Format** | BSD (RFC 3164) ou IETF (RFC 5424) |

3. **S√©lectionnez les types de logs √† envoyer :**
   - ‚úÖ Logs de filtrage (r√®gles pare-feu)
   - ‚úÖ Logs IPS (alertes de s√©curit√©)
   - ‚úÖ Logs syst√®me (authentification, modifications de configuration)

4. **Testez l'envoi** : G√©n√©rez du trafic (ping, HTTP) et v√©rifiez que les logs arrivent sur le serveur Syslog

</Steps>

---

#### Exploitation des logs centralis√©s

Consultez les logs centralis√©s et cr√©ez quelques requ√™tes utiles :

**Exemples de requ√™tes (syntaxe d√©pend de votre outil Syslog) :**
```
# Toutes les connexions bloqu√©es
action="BLOCK"

# Alertes IPS uniquement
facility="IPS"

# Connexions vers la DMZ depuis Internet
src_zone="OUT" AND dst_zone="DMZ"

# Tentatives DMZ ‚Üí LAN (doit √™tre vide ou tr√®s rare)
src_zone="DMZ" AND dst_zone="IN"
```

**Cr√©ez un dashboard** affichant :
- Nombre de connexions bloqu√©es par heure
- Top 5 des IP sources bloqu√©es
- Alertes IPS des derni√®res 24h

---

### T√¢che 11 ‚≠ê‚≠ê : Affinage des r√®gles de pare-feu

Am√©liorez la s√©curit√© en restreignant davantage les acc√®s.

#### Restriction par IP source (administration)

Modifiez les r√®gles 3a, 3b, 3c pour limiter l'administration √† un seul poste :

**R√®gle 3a modifi√©e :**

| Param√®tre | Avant | Apr√®s |
|-----------|-------|-------|
| **Source** | `net_lan` | `host_admin_poste` (172.17.0.100) |

**Justification** : Seul le poste d'administration doit pouvoir g√©rer les serveurs DMZ, pas tous les postes du LAN.

Faites de m√™me pour les r√®gles 3b et 3c.

---

#### Ajout de r√®gles ICMP contr√¥l√©es

Autorisez le ping de mani√®re s√©lective pour le diagnostic r√©seau.

**Nouvelle r√®gle : LAN ‚Üí Ping ALL**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `LAN Ping diagnostic` |
| **Source** | `net_lan` |
| **Destination** | Any |
| **Service** | ICMP Echo Request (ping) |
| **Action** | **PASS** |
| **Log** | - |

**Nouvelle r√®gle : Blocage ping depuis Internet**

| Param√®tre | Valeur |
|-----------|--------|
| **Nom** | `Block ping from Internet` |
| **Source** | Interface OUT |
| **Destination** | `net_dmz`, `net_lan` |
| **Service** | ICMP Echo Request |
| **Action** | **BLOCK** |
| **Log** | - |

**Justification** : Permet le diagnostic interne mais emp√™che le _ping scanning_ depuis Internet.

---

### T√¢che 12 ‚≠ê‚≠ê‚≠ê : Filtrage applicatif avanc√©

Activez des fonctionnalit√©s de pare-feu nouvelle g√©n√©ration.

#### Filtrage d'URL (si SNS le supporte)

**Configuration > S√©curit√© > Filtrage web**

<Steps>

1. **Activez le filtrage d'URL**

2. **Bloquez les cat√©gories dangereuses :**
   - Adulte / Pornographie
   - Jeux d'argent
   - Malware / Phishing
   - Proxy anonymes / VPN
   - Violence / Haine

3. **Appliquez le filtrage** aux flux `LAN ‚Üí OUT`

4. **Testez** : Depuis `admin-poste`, essayez d'acc√©der √† un site bloqu√© ‚Üí Doit √™tre refus√© avec une page de blocage

</Steps>

---

#### Limitation de bande passante (QoS)

**Configuration > R√©seau > QoS**

<Steps>

1. **Cr√©ez une r√®gle QoS pour le LAN :**
   - Flux : `net_lan` ‚Üí OUT
   - Bande passante garantie : 80% du d√©bit total
   - Bande passante maximale : 100%

2. **Cr√©ez une r√®gle QoS pour la DMZ :**
   - Flux : `net_dmz` ‚Üí OUT
   - Bande passante garantie : 10%
   - Bande passante maximale : 20%

3. **Appliquez** la configuration

</Steps>

**Justification** : Priorit√© au trafic utilisateur (LAN). La DMZ ne doit utiliser la bande passante que pour les mises √† jour (trafic non critique).

---

#### G√©o-restriction (blocage par pays)

**Configuration > S√©curit√© > G√©olocalisation**

<Steps>

1. **Activez la g√©olocalisation**

2. **Cr√©ez une r√®gle de blocage g√©ographique :**
   - Flux : OUT ‚Üí DMZ (acc√®s public GLPI)
   - Pays bloqu√©s : Tous **sauf** Union Europ√©enne + Am√©rique du Nord
   - Action : BLOCK
   - Log : Alarm

3. **Appliquez** la configuration

</Steps>

**Justification** : Le CRASH op√®re principalement en France. Les connexions depuis des pays lointains sont suspectes et peuvent √™tre bloqu√©es.

---

### T√¢che 13 ‚≠ê‚≠ê‚≠ê : Audit de s√©curit√© complet

R√©alisez une batterie de tests pour valider la robustesse de votre architecture.

#### Test 1 : Segmentation r√©seau

**Objectif** : V√©rifier que la DMZ ne peut pas acc√©der au LAN.

<Steps>

1. Depuis `glpi-srv01`, tentez de scanner le r√©seau LAN :
   ```bash
      nmap -sn 172.17.0.0/16
   ```

2. Tentez d'acc√©der √† un service du LAN :
   ```bash
      curl http://172.17.0.100
      ssh user@172.17.0.100
   ```

</Steps>

‚úÖ **Attendu** : Tous les tests √©chouent. V√©rifiez les logs EVA1 : des alarmes doivent √™tre lev√©es.

---

#### Test 2 : R√©sistance au scan de ports

**Objectif** : V√©rifier que l'IPS d√©tecte et bloque les scans agressifs.

Depuis une machine externe au labo :
```bash
# Scan SYN rapide (agressif)
sudo nmap -sS -T5 172.25.x.y

# Scan de tous les ports
sudo nmap -p- 172.25.x.y
```

‚úÖ **Attendu** :
- Le scan est d√©tect√© dans les logs IPS
- Certaines connexions sont bloqu√©es (rate limiting)
- Le scanner est potentiellement mis en liste noire temporairement

---

#### Test 3 : Injection SQL (simulation)

**Objectif** : V√©rifier que l'IPS d√©tecte les tentatives d'injection SQL.

Depuis un navigateur externe, tentez d'acc√©der √† :
```
https://172.25.x.y/index.php?id=1' OR '1'='1
https://172.25.x.y/index.php?id=1; DROP TABLE users--
```

‚úÖ **Attendu** :
- Les requ√™tes sont bloqu√©es par l'IPS
- Une alerte ¬´ SQL Injection ¬ª appara√Æt dans les logs IPS

---

#### Test 4 : V√©rification du NAT

**Objectif** : Confirmer que les IP priv√©es sont bien masqu√©es.

<Steps>

1. Depuis `glpi-srv01`, acc√©dez √† un service qui affiche votre IP publique :
   ```bash
      curl https://ifconfig.me
   ```

2. L'IP affich√©e doit √™tre **172.25.x.y** (IP publique de l'EVA1), **PAS** 10.54.0.10

</Steps>

‚úÖ **Attendu** : Le NAT fonctionne, l'IP priv√©e est masqu√©e.

---

#### Test 5 : V√©rification de l'anti-spoofing

**Objectif** : Confirmer que les paquets usurp√©s sont bloqu√©s.

Ce test n√©cessite un outil avanc√© comme `hping3` ou `scapy`. Depuis une machine externe :
```bash
# Envoi d'un paquet avec IP source usurp√©e
sudo hping3 -S -a 172.17.0.100 -p 443 172.25.x.y
```

‚úÖ **Attendu** : Le paquet est bloqu√© par la r√®gle d'anti-spoofing, une alarme est lev√©e.

---

#### Rapport d'audit

R√©digez un **rapport d'audit de s√©curit√©** incluant :

1. **R√©sultats des 5 tests** (succ√®s/√©chec)
2. **Captures d'√©cran** des logs IPS et alarmes
3. **Analyse des vuln√©rabilit√©s** r√©siduelles identifi√©es
4. **Recommandations** pour am√©liorer encore la s√©curit√©

Ce rapport sera un √©l√©ment majeur de votre portfolio.

---

## Livrables attendus

### ‚≠ê Livrables niveau 1 (obligatoires)

<CardGrid>
  <Card title="Sch√©ma r√©seau complet" icon="diagram">
    Topologie avec toutes les VMs, interfaces, IP, zones de s√©curit√©
  </Card>
  <Card title="Documentation des r√®gles pare-feu" icon="list-format">
    Tableau r√©capitulatif de toutes les r√®gles avec justifications
  </Card>
  <Card title="Plan d'adressage" icon="network">
    Tableau complet des IP, masques, passerelles
  </Card>
  <Card title="Proc√©dure de configuration" icon="open-book">
    Guide pas √† pas pour reproduire l'architecture
  </Card>
  <Card title="R√©sultats des tests" icon="checkmark">
    Tests 1 √† 6 r√©alis√©s et document√©s
  </Card>
  <Card title="Captures d'√©cran" icon="image">
    Interface EVA1, r√®gles configur√©es, logs de blocage DMZ‚ÜíLAN
  </Card>
</CardGrid>

### ‚≠ê‚≠ê Livrables niveau 2

<CardGrid>
  <Card title="Configuration IPS" icon="shield">
    Profils activ√©s, logs d'alertes g√©n√©r√©es
  </Card>
  <Card title="Logs centralis√©s" icon="server">
    Syslog configur√©, dashboard cr√©√©
  </Card>
  <Card title="R√®gles affin√©es" icon="lock">
    Restrictions par IP source, ICMP contr√¥l√©
  </Card>
  <Card title="Tests IPS" icon="scan">
    R√©sultats des scans Nmap/Nikto avec alertes
  </Card>
</CardGrid>

### ‚≠ê‚≠ê‚≠ê Livrables niveau 3

<CardGrid>
  <Card title="Filtrage applicatif" icon="filter">
    URL filtering, QoS, g√©o-restriction configur√©s
  </Card>
  <Card title="Rapport d'audit" icon="document">
    5 tests de s√©curit√© r√©alis√©s et analys√©s
  </Card>
  <Card title="Analyse de vuln√©rabilit√©s" icon="warning">
    Failles identifi√©es + recommandations
  </Card>
  <Card title="Matrice de flux d√©taill√©e" icon="table">
    Tous les flux autoris√©s/bloqu√©s document√©s
  </Card>
</CardGrid>

---

## Crit√®res d'√©valuation

| Crit√®re | ‚≠ê Niveau 1 | ‚≠ê‚≠ê Niveau 2 | ‚≠ê‚≠ê‚≠ê Niveau 3 |
|---------|------------|--------------|---------------|
| **Architecture r√©seau** | 3 zones configur√©es (OUT/DMZ/IN) | Idem + architecture modulaire g√©r√©e | Idem + optimisations QoS |
| **R√®gles pare-feu** | 8 r√®gles de base fonctionnelles | + R√®gles affin√©es par IP | + Filtrage applicatif (URL, g√©o) |
| **NAT/PAT** | NAT sortant + DNAT GLPI | Idem + documentation d√©taill√©e | Idem + tests de validation |
| **S√©curit√©** | Blocage DMZ‚ÜíLAN op√©rationnel | + IPS activ√© et test√© | + Audit complet avec rapport |
| **Logs** | Logs consult√©s dans EVA1 | + Centralisation Syslog + dashboard | + Corr√©lation d'√©v√©nements |
| **Tests** | 6 tests de base r√©ussis | + Tests IPS document√©s | + 5 tests d'audit avanc√©s |
| **Documentation** | Sch√©ma + proc√©dure | + Justifications techniques | + Rapport d'audit professionnel |

---

## Ressources compl√©mentaires

- [Documentation Stormshield SNS](https://documentation.stormshield.eu/)
- [Guide de configuration pare-feu](https://www.stormshield.com/fr/ressources/)
- [Bonnes pratiques DMZ](https://www.sans.org/white-papers/)
- [Tests de s√©curit√© avec Nmap](https://nmap.org/book/man.html)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

:::tip[Prochaine √©tape]
Une fois cette mission termin√©e et valid√©e, vous pourrez passer √† la [Mission 3 - S√©curisation SSH](/missions/mission-3) o√π vous mettrez en place un acc√®s d'administration √† distance s√©curis√©.
:::

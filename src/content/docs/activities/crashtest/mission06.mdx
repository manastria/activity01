---
title: Mission 6 - Services compl√©mentaires et optimisation
description: Ajout de services professionnels sur le cluster et optimisation globale de l'infrastructure
---

import { Steps, Card, CardGrid, Aside } from '@astrojs/starlight/components';

# Mission 6 : Services compl√©mentaires et optimisation

## Objectif

Enrichir l'infrastructure haute disponibilit√© avec des services compl√©mentaires professionnels et optimiser les performances globales du cluster GLPI.

<CardGrid>
  <Card title="Difficult√©" icon="star">
    Difficile üí™
  </Card>
  <Card title="Temps estim√©" icon="clock">
    6 heures
  </Card>
</CardGrid>

## Pr√©requis

- Avoir termin√© la Mission 5 (cluster HA op√©rationnel)
- Ma√Ætriser l'administration syst√®me Linux avanc√©e
- Comprendre les concepts de reverse proxy et de cache
- Conna√Ætre les bases de la s√©curit√© applicative

## Contexte

Le cluster GLPI du CRASH est maintenant hautement disponible, mais plusieurs besoins compl√©mentaires ont √©t√© identifi√©s :

**Besoins de s√©curit√© :**
- Mise en place d'une PKI interne pour des certificats SSL professionnels
- Renforcement de la s√©curit√© applicative (WAF)
- Authentification centralis√©e pour simplifier la gestion des utilisateurs

**Besoins de performance :**
- Les temps de chargement GLPI sont parfois lents (base de donn√©es volumineuse)
- Certaines pages contiennent beaucoup de contenu statique (CSS, JS, images)
- Les requ√™tes r√©p√©titives sollicitent inutilement la base de donn√©es

**Besoins op√©rationnels :**
- Sauvegarde automatis√©e de l'ensemble du cluster
- Tests de restauration r√©guliers
- Documentation de l'infrastructure √† jour automatiquement

:::caution[Cahier des charges]
**Objectifs de cette mission :**
- Remplacer les certificats auto-sign√©s par des certificats d'une PKI interne
- Am√©liorer les performances du portail GLPI (temps de chargement < 2 secondes)
- Mettre en place une sauvegarde compl√®te automatis√©e du cluster
- Tester et valider les proc√©dures de restauration

**Contraintes :**
- Ne pas perturber le service en production (d√©ploiement progressif)
- Conserver la haute disponibilit√© acquise en Mission 5
- Limiter la consommation de ressources (budget serveurs limit√©)
:::

:::tip[Approche p√©dagogique]
Cette mission propose trois niveaux de r√©alisation :
- ‚≠ê PKI interne, cache web et sauvegarde de base
- ‚≠ê‚≠ê Optimisations avanc√©es et WAF
- ‚≠ê‚≠ê‚≠ê Authentification centralis√©e et infrastructure as code

Chaque niveau inclut le pr√©c√©dent. Visez au minimum le niveau ‚≠ê pour valider la mission.
:::

---

## Services √† d√©ployer

### PKI (Public Key Infrastructure)

Une infrastructure de cl√©s publiques permet de g√©rer des certificats SSL/TLS internes sans d√©pendre d'autorit√©s externes.

**Composants d'une PKI :**

**CA racine (Root CA) :**
- Certificat auto-sign√© de plus haut niveau
- Signe les certificats d'autorit√©s interm√©diaires
- **Doit √™tre hors ligne** et ultra-s√©curis√© en production

**CA interm√©diaire (Intermediate CA) :**
- Sign√©e par la CA racine
- Signe les certificats finaux (serveurs, utilisateurs)
- Peut √™tre en ligne pour automatiser la signature

**Certificats serveur :**
- Certificats SSL/TLS pour les serveurs web
- Sign√©s par la CA interm√©diaire
- Install√©s sur HAProxy pour le HTTPS

**Avantages d'une PKI interne :**
- ‚úÖ Pas d'avertissement navigateur (si CA racine install√©e sur les postes)
- ‚úÖ Contr√¥le total sur l'√©mission et la r√©vocation
- ‚úÖ Gratuit et personnalisable
- ‚úÖ Dur√©e de validit√© configurable

### Reverse Proxy avec cache

Un reverse proxy avec cache permet d'am√©liorer drastiquement les performances.

**Varnish Cache :**
- Proxy HTTP haute performance
- Met en cache les r√©ponses HTTP
- Peut g√©rer des dizaines de milliers de requ√™tes/seconde
- Langage de configuration puissant (VCL)

**O√π l'int√©grer :**
```
Clients ‚Üí HAProxy ‚Üí Varnish ‚Üí Serveurs GLPI
```

Ou :
```
Clients ‚Üí Varnish ‚Üí HAProxy ‚Üí Serveurs GLPI
```

**Configuration type :**
- Cache des √©l√©ments statiques (CSS, JS, images) pour longue dur√©e
- Cache des pages HTML pour courte dur√©e (ou pas du tout selon la dynamicit√©)
- Invalidation automatique du cache lors de modifications GLPI

### WAF (Web Application Firewall)

Un pare-feu applicatif prot√®ge contre les attaques web courantes.

**ModSecurity :**
- WAF open source int√©grable √† Nginx/Apache
- D√©tecte et bloque les attaques OWASP Top 10
- Utilise des r√®gles (Core Rule Set - CRS)

**Protections offertes :**
- Injection SQL
- Cross-Site Scripting (XSS)
- Inclusion de fichiers (LFI/RFI)
- Travers√©e de r√©pertoires
- Attaques par force brute

**O√π l'int√©grer :**
- Sur HAProxy (avec module Lua)
- Sur les serveurs web eux-m√™mes
- Sur un reverse proxy d√©di√© (Nginx + ModSecurity)

### Authentification centralis√©e

Centraliser l'authentification simplifie la gestion des utilisateurs.

**Solutions possibles :**

**LDAP/Active Directory :**
- Annuaire centralis√© des utilisateurs
- GLPI peut s'authentifier contre LDAP/AD
- Synchronisation automatique des utilisateurs

**SSO (Single Sign-On) avec Keycloak :**
- Solution moderne d'authentification
- Support SAML, OAuth2, OpenID Connect
- Interface d'administration compl√®te

**Avantages :**
- ‚úÖ Un seul mot de passe pour tous les services
- ‚úÖ Gestion centralis√©e des droits
- ‚úÖ D√©sactivation d'un compte = blocage partout

---

## T√¢ches √† r√©aliser

### T√¢che 1 ‚≠ê : Mise en place d'une PKI interne

Cr√©ez votre propre autorit√© de certification pour g√©n√©rer des certificats SSL professionnels.

#### √âtape 1.1 : Cr√©ation de la CA racine

**Sur une machine d√©di√©e** (peut √™tre votre h√¥te ou une VM temporaire) :

1. Installez OpenSSL (normalement d√©j√† pr√©sent)

2. Cr√©ez une structure de r√©pertoires pour la PKI :
```
   pki/
   ‚îú‚îÄ‚îÄ ca/
   ‚îÇ   ‚îú‚îÄ‚îÄ private/      # Cl√©s priv√©es (prot√©g√©es)
   ‚îÇ   ‚îú‚îÄ‚îÄ certs/        # Certificats sign√©s
   ‚îÇ   ‚îî‚îÄ‚îÄ newcerts/     # Nouveaux certificats
   ‚îú‚îÄ‚îÄ intermediate/
   ‚îÇ   ‚îú‚îÄ‚îÄ private/
   ‚îÇ   ‚îú‚îÄ‚îÄ certs/
   ‚îÇ   ‚îî‚îÄ‚îÄ csr/          # Certificate Signing Requests
```

3. G√©n√©rez la cl√© priv√©e de la CA racine :
   - Algorithme : RSA 4096 bits ou Ed25519
   - Prot√©g√©e par passphrase robuste

4. Cr√©ez le certificat auto-sign√© de la CA racine :
   - Dur√©e de validit√© : 10 ans (3650 jours)
   - Distinguished Name (DN) : `CN=CRASH Root CA, O=CRASH, C=FR`

:::caution[S√©curit√© de la CA racine]
La cl√© priv√©e de la CA racine est **ultra-sensible**. En production :
- Elle doit √™tre hors ligne (machine d√©connect√©e)
- Stock√©e dans un coffre-fort physique
- Avec plusieurs copies de sauvegarde chiffr√©es

Pour ce projet p√©dagogique, stockez-la dans un r√©pertoire avec permissions restrictives (`chmod 400`).
:::

#### √âtape 1.2 : Cr√©ation de la CA interm√©diaire

La CA interm√©diaire signe les certificats quotidiens (serveurs, utilisateurs).

1. G√©n√©rez une cl√© priv√©e pour la CA interm√©diaire

2. Cr√©ez une CSR (Certificate Signing Request) pour la CA interm√©diaire :
   - DN : `CN=CRASH Intermediate CA, O=CRASH, C=FR`

3. Signez la CSR avec la CA racine pour obtenir le certificat interm√©diaire :
   - Dur√©e de validit√© : 5 ans
   - Extension `basicConstraints = CA:TRUE, pathlen:0`

4. V√©rifiez la cha√Æne de certification :
```bash
   # V√©rifier que le certificat interm√©diaire est bien sign√© par la racine
   openssl verify -CAfile ca/certs/root-ca.crt intermediate/certs/intermediate-ca.crt
```

#### √âtape 1.3 : G√©n√©ration des certificats serveur

Cr√©ez un certificat SSL pour HAProxy couvrant tous les noms d'h√¥tes n√©cessaires.

1. G√©n√©rez une cl√© priv√©e pour le serveur

2. Cr√©ez une CSR avec Subject Alternative Names (SAN) :
   - CN : `glpi.crash.lan` (ou votre nom de domaine)
   - SAN : Ajoutez toutes les IP et noms d'h√¥tes n√©cessaires
     - `DNS:glpi.crash.lan`
     - `DNS:*.crash.lan` (wildcard si besoin)
     - `IP:10.54.0.1` (VIP)

3. Signez la CSR avec la CA interm√©diaire :
   - Dur√©e de validit√© : 1 an (390 jours)
   - Extension `keyUsage = digitalSignature, keyEncipherment`
   - Extension `extendedKeyUsage = serverAuth`

4. Cr√©ez le bundle de certificats pour HAProxy :
   - Concat√©nez : cl√© priv√©e + certificat serveur + certificat interm√©diaire
   - Format PEM

:::tip[Format de certificat HAProxy]
HAProxy n√©cessite un fichier unique contenant :
```
-----BEGIN PRIVATE KEY-----
[cl√© priv√©e du serveur]
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
[certificat du serveur]
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
[certificat CA interm√©diaire]
-----END CERTIFICATE-----
```

Cr√©ez ce fichier avec :
```bash
cat server-key.pem server-cert.pem intermediate-ca.crt > haproxy-bundle.pem
chmod 600 haproxy-bundle.pem
```
:::

#### √âtape 1.4 : Installation sur HAProxy

1. Copiez le bundle sur les serveurs HAProxy (`haproxy01`, `haproxy02`)

2. Modifiez la configuration HAProxy pour utiliser le nouveau certificat :
```
   frontend https_front
       bind *:443 ssl crt /etc/haproxy/certs/haproxy-bundle.pem
```

3. Rechargez HAProxy sans interruption de service :
```bash
   sudo systemctl reload haproxy
```

4. Testez l'acc√®s HTTPS : `curl -v https://[VIP]`

#### √âtape 1.5 : Distribution de la CA racine

Pour que les navigateurs acceptent vos certificats sans avertissement, installez la CA racine sur les postes clients.

**Sur Linux :**
```bash
sudo cp ca/certs/root-ca.crt /usr/local/share/ca-certificates/crash-root-ca.crt
sudo update-ca-certificates
```

**Sur Windows :**
- Importer dans le magasin ¬´ Autorit√©s de certification racines de confiance ¬ª

**Sur navigateur :**
- Firefox : Pr√©f√©rences ‚Üí Certificats ‚Üí Importer

**Testez** : Acc√©dez √† `https://[VIP]` ‚Üí Pas d'avertissement de s√©curit√©.

---

### T√¢che 2 ‚≠ê‚≠ê : Mise en cache avec Varnish

Am√©liorez les performances en mettant en cache les contenus statiques et certaines pages dynamiques.

#### Installation de Varnish

Installez Varnish sur une ou plusieurs VMs d√©di√©es (ou sur les HAProxy si ressources suffisantes).

**Architecture cible :**
```
Clients ‚Üí HAProxy:443 (HTTPS) ‚Üí Varnish:80 (HTTP) ‚Üí Serveurs GLPI:80
```

HAProxy fait la terminaison SSL, Varnish g√®re le cache en HTTP.

#### Configuration de base

Cr√©ez une configuration Varnish (VCL) adapt√©e √† GLPI :

**√âl√©ments √† configurer :**

1. **Backend** : D√©finir les serveurs GLPI backend
```vcl
   backend glpi_web01 {
       .host = "10.54.0.10";
       .port = "80";
   }
```

2. **R√®gles de cache** :
   - **Mettre en cache** : CSS, JS, images, fonts (longue dur√©e : 1 semaine)
   - **Ne PAS mettre en cache** : Pages dynamiques avec sessions
   - **Cache court** : Pages publiques peu modifi√©es (ex: liste des cat√©gories)

3. **Gestion des cookies** :
   - GLPI utilise des cookies de session
   - Ne pas mettre en cache les requ√™tes avec cookie de session actif

4. **Purge du cache** :
   - Permettre de vider le cache manuellement (commande `varnishadm`)
   - Ou via une requ√™te HTTP sp√©cifique (PURGE)

**Exemple de r√®gle VCL :**
```vcl
sub vcl_recv {
    # Ne pas mettre en cache les requ√™tes avec cookies de session
    if (req.http.Cookie ~ "glpi_") {
        return (pass);
    }

    # Mettre en cache les fichiers statiques
    if (req.url ~ "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2)$") {
        return (hash);
    }
}

sub vcl_backend_response {
    # Cache des statiques : 1 semaine
    if (bereq.url ~ "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2)$") {
        set beresp.ttl = 7d;
    }
}
```

#### Reconfiguration de HAProxy

Modifiez HAProxy pour qu'il envoie le trafic vers Varnish au lieu des serveurs web directement :
```
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/haproxy-bundle.pem
    default_backend varnish_backend

backend varnish_backend
    server varnish01 10.54.0.20:80 check
```

#### Tests de performance

Comparez les performances avant/apr√®s Varnish :

**Avant Varnish :**
```bash
ab -n 1000 -c 10 https://[VIP]/
```

**Apr√®s Varnish :**
```bash
ab -n 1000 -c 10 https://[VIP]/
```

**Mesurez** :
- Temps de r√©ponse moyen
- Requ√™tes par seconde
- Taux de cache hit/miss (via `varnishstat`)

**Objectif** : Temps de chargement < 2 secondes, am√©lioration d'au moins 30% pour le contenu statique.

---

### T√¢che 3 ‚≠ê : Sauvegarde automatis√©e du cluster

Mettez en place une strat√©gie de sauvegarde compl√®te de l'infrastructure.

#### √âl√©ments √† sauvegarder

**Bases de donn√©es :**
- Dump SQL de la base GLPI
- Dump de toutes les bases syst√®me si n√©cessaire

**Fichiers GLPI :**
- R√©pertoire `/var/www/html/glpi` (application)
- R√©pertoire `/var/www/html/glpi/files` (documents upload√©s)
- Fichiers de configuration GLPI

**Configurations syst√®me :**
- Configurations HAProxy, Keepalived, Varnish
- Configurations MySQL/MariaDB
- Configurations des serveurs web

**Certificats et cl√©s :**
- Certificats SSL/TLS
- Cl√©s priv√©es (chiffr√©es)

#### Script de sauvegarde

Cr√©ez un script de sauvegarde automatis√© qui :

1. **Dump la base de donn√©es** :
   - Utilisez `mysqldump` ou `mariadb-dump`
   - Option `--single-transaction` pour coh√©rence sans verrouillage
   - Compression avec `gzip`

2. **Archive les fichiers** :
   - Utilisez `tar` avec compression (`tar czf`)
   - Horodatage dans le nom du fichier (ex: `backup-20260206-143000.tar.gz`)

3. **Copie vers serveur de sauvegarde distant** :
   - Utilisez `rsync` sur SSH ou `scp`
   - Serveur de sauvegarde hors du cluster (r√©silience)

4. **Rotation des sauvegardes** :
   - Conservation : 7 sauvegardes quotidiennes, 4 hebdomadaires, 3 mensuelles
   - Suppression automatique des anciennes sauvegardes

5. **V√©rification d'int√©grit√©** :
   - Checksum MD5 ou SHA256 des archives
   - Test de d√©compression

**Planification** :
- Sauvegarde quotidienne √† 2h du matin (via `cron`)
- Notification par email en cas d'√©chec

:::tip[Serveur de sauvegarde]
Cr√©ez une VM d√©di√©e `backup-srv` :
- Hors du cluster GLPI (r√©silience)
- Grand stockage (plusieurs sauvegardes)
- Acc√®s SSH s√©curis√© par cl√©s
:::

#### Test de restauration

**Documentez et testez** la proc√©dure de restauration compl√®te :

1. D√©truisez une VM (ex: `glpi-web02`) pour simuler une perte totale

2. Recr√©ez une VM vierge

3. Restaurez depuis la sauvegarde :
   - Restaurer les fichiers GLPI
   - Importer le dump SQL
   - Restaurer les configurations

4. R√©int√©grez le serveur dans le cluster

5. V√©rifiez que GLPI fonctionne normalement

**Mesurez le RTO r√©el** : Temps total de restauration.

---

### T√¢che 4 ‚≠ê‚≠ê : Optimisation des performances MySQL

Optimisez la base de donn√©es pour am√©liorer les performances globales.

#### Analyse des performances actuelles

**Identifiez les requ√™tes lentes :**

1. Activez le slow query log MySQL :
```ini
   slow_query_log = 1
   slow_query_log_file = /var/log/mysql/slow.log
   long_query_time = 2
```

2. Analysez les requ√™tes lentes avec `mysqldumpslow` ou `pt-query-digest`

3. Identifiez les tables sans index ou mal index√©es

**Analysez l'utilisation des ressources :**
- `SHOW PROCESSLIST;` : Voir les requ√™tes en cours
- `SHOW STATUS;` : Statistiques globales
- `mysqltuner` : Script d'analyse automatique

#### Optimisations √† appliquer

**Ajout d'index :**
- Identifiez les colonnes fr√©quemment utilis√©es dans les `WHERE`, `JOIN`, `ORDER BY`
- Cr√©ez des index appropri√©s (attention √† ne pas sur-indexer)

**Configuration MySQL** (`/etc/mysql/my.cnf` ou √©quivalent) :

**Optimisations m√©moire :**
```ini
innodb_buffer_pool_size = 70% de la RAM disponible
innodb_log_file_size = 256M
query_cache_size = 0  # D√©sactiv√© (deprecated en MySQL 8)
max_connections = 200
```

**Optimisations performances :**
```ini
innodb_flush_log_at_trx_commit = 2  # Am√©liore perfs, l√©ger risque
innodb_file_per_table = 1
```

**Red√©marrez MySQL** et testez les performances :
```bash
mysqlslap --auto-generate-sql --concurrency=50 --iterations=10
```

#### Mise en cache applicative

**Cache Redis pour GLPI** (si support√©) :
- Installez Redis sur un serveur d√©di√© ou sur les n≈ìuds web
- Configurez GLPI pour utiliser Redis comme cache backend
- Stockage des sessions PHP dans Redis (partag√© entre serveurs web)

---

### T√¢che 5 ‚≠ê‚≠ê : D√©ploiement d'un WAF (Web Application Firewall)

Prot√©gez GLPI contre les attaques web courantes.

#### Installation de ModSecurity

**Option 1 : ModSecurity sur Nginx (reverse proxy d√©di√©)**

Cr√©ez un reverse proxy Nginx avec ModSecurity en amont de HAProxy :
```
Clients ‚Üí Nginx + ModSecurity ‚Üí HAProxy ‚Üí Varnish ‚Üí GLPI
```

**Option 2 : ModSecurity sur les serveurs web Apache**

Installez ModSecurity directement sur `glpi-web01`, `glpi-web02`.

#### Configuration du Core Rule Set (CRS)

1. T√©l√©chargez le OWASP ModSecurity Core Rule Set (CRS)

2. Installez les r√®gles dans ModSecurity

3. Configurez le niveau de paranoia :
   - Niveau 1 : Protection de base (peu de faux positifs)
   - Niveau 2 : Protection renforc√©e
   - Niveau 3-4 : Protection maximale (beaucoup de faux positifs)

4. Mode de fonctionnement :
   - **DetectionOnly** : D√©tecte et logue, ne bloque pas (phase de test)
   - **On** : Bloque les requ√™tes malveillantes

**R√®gles activ√©es par d√©faut :**
- Injection SQL (SQLi)
- Cross-Site Scripting (XSS)
- Remote File Inclusion (RFI)
- Local File Inclusion (LFI)
- Remote Code Execution (RCE)
- Path Traversal

#### Phase de tuning

Le WAF peut g√©n√©rer des **faux positifs** (bloquer des requ√™tes l√©gitimes).

**M√©thodologie de tuning :**

1. D√©ployez en mode `DetectionOnly` pendant 1 semaine

2. Analysez les logs ModSecurity pour identifier les faux positifs

3. Cr√©ez des r√®gles d'exclusion pour les faux positifs :
```apache
   # Exemple : d√©sactiver une r√®gle sp√©cifique pour une URL
   SecRuleRemoveById 942100
```

4. Passez en mode `On` (blocage actif)

5. Surveillez les logs et ajustez

**Testez le WAF** :
- Tentez une injection SQL dans un champ de recherche GLPI
- Tentez un XSS dans un champ texte
- V√©rifiez que les attaques sont bloqu√©es et logu√©es

---

### T√¢che 6 ‚≠ê‚≠ê : Monitoring avanc√© et dashboards

Am√©liorez la supervision avec des dashboards d√©taill√©s et des alertes pertinentes.

#### Dashboards Grafana personnalis√©s

Cr√©ez des dashboards sp√©cifiques pour votre infrastructure :

**Dashboard 1 : Vue d'ensemble du cluster**
- Statut de chaque n≈ìud (up/down)
- Trafic global (requ√™tes/seconde)
- Temps de r√©ponse moyen
- Taux d'erreurs HTTP
- Utilisation CPU/RAM/Disque de chaque serveur

**Dashboard 2 : Performance HAProxy**
- R√©partition du trafic entre backends
- Nombre de connexions actives
- Sessions en cours
- Taux de basculement (failover)
- Health checks status

**Dashboard 3 : Performance MySQL**
- R√©plication lag (retard de r√©plication)
- Connexions actives
- Requ√™tes lentes
- Cache hit ratio
- Locks et deadlocks

**Dashboard 4 : Performance Varnish**
- Cache hit rate (%)
- Backend connections
- Requ√™tes en cache vs passthrough
- M√©moire cache utilis√©e

**Dashboard 5 : S√©curit√©**
- Alertes ModSecurity (attaques bloqu√©es)
- Tentatives de connexion SSH √©chou√©es (depuis Mission 3)
- Alertes IPS pare-feu (depuis Mission 2)

#### Alertes intelligentes

Configurez des alertes avec seuils adaptatifs :

**Alertes critiques (notification imm√©diate) :**
- N≈ìud du cluster down > 1 minute
- R√©plication MySQL cass√©e
- Espace disque < 10%
- Certificat SSL expire dans moins de 7 jours

**Alertes warning (notification quotidienne regroup√©e) :**
- Temps de r√©ponse > 3 secondes pendant 10 minutes
- CPU > 80% pendant 30 minutes
- Requ√™tes lentes MySQL > 50/heure
- Attaques WAF > 100/heure

**Notifications :**
- Email pour les alertes critiques
- Slack/Mattermost/Discord pour les warnings
- SMS (via service externe) pour les pannes critiques hors heures ouvrables

---

### T√¢che 7 ‚≠ê‚≠ê‚≠ê : Authentification centralis√©e LDAP

Int√©grez GLPI avec un annuaire LDAP pour centraliser la gestion des utilisateurs.

#### D√©ploiement d'un serveur LDAP

**Option 1 : OpenLDAP**
- Serveur LDAP classique et mature
- Configuration manuelle (fichiers LDIF)

**Option 2 : FreeIPA**
- Solution compl√®te (LDAP + Kerberos + DNS + CA)
- Interface web d'administration
- Plus simple √† g√©rer

**Option 3 : Active Directory (Windows Server)**
- Si infrastructure Windows disponible

**Pour ce projet, utilisez OpenLDAP ou FreeIPA.**

#### Structure de l'annuaire LDAP

Cr√©ez une structure adapt√©e au CRASH :
```
dc=crash,dc=lan
‚îú‚îÄ‚îÄ ou=users
‚îÇ   ‚îú‚îÄ‚îÄ cn=Jean Dupont
‚îÇ   ‚îú‚îÄ‚îÄ cn=Marie Martin
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ ou=groups
‚îÇ   ‚îú‚îÄ‚îÄ cn=admin
‚îÇ   ‚îú‚îÄ‚îÄ cn=techniciens
‚îÇ   ‚îî‚îÄ‚îÄ cn=utilisateurs
‚îî‚îÄ‚îÄ ou=services
    ‚îî‚îÄ‚îÄ cn=glpi (compte de service)
```

**Cr√©ez des utilisateurs de test** avec attributs appropri√©s (uid, mail, givenName, sn, etc.)

#### Configuration GLPI pour LDAP

Dans l'interface d'administration GLPI :

1. **Configuration ‚Üí Authentification ‚Üí Annuaire LDAP**

2. Ajoutez un annuaire LDAP :
   - Serveur : `ldap://[IP_serveur_LDAP]:389`
   - Base DN : `dc=crash,dc=lan`
   - Filtre de recherche : `(objectClass=inetOrgPerson)`
   - Compte de connexion : `cn=glpi,ou=services,dc=crash,dc=lan`

3. Configurez le mapping des attributs :
   - Login : `uid`
   - Nom : `sn`
   - Pr√©nom : `givenName`
   - Email : `mail`

4. Configurez l'import automatique des utilisateurs

5. Mappez les groupes LDAP vers les profils GLPI :
   - Groupe LDAP `admin` ‚Üí Profil GLPI `Super-Admin`
   - Groupe LDAP `techniciens` ‚Üí Profil GLPI `Technicien`
   - Groupe LDAP `utilisateurs` ‚Üí Profil GLPI `Self-Service`

#### Tests

1. Tentez de vous connecter √† GLPI avec un compte LDAP
2. V√©rifiez que l'utilisateur est automatiquement cr√©√© dans GLPI
3. V√©rifiez que les droits sont correctement attribu√©s selon le groupe LDAP
4. Modifiez un attribut dans LDAP (email) et v√©rifiez la synchronisation

---

### T√¢che 8 ‚≠ê‚≠ê‚≠ê : Infrastructure as Code avec Ansible

Automatisez compl√®tement le d√©ploiement de votre infrastructure avec Ansible.

#### Structure du projet Ansible

Cr√©ez une structure de projet propre :
```
ansible-glpi-cluster/
‚îú‚îÄ‚îÄ inventory/
‚îÇ   ‚îú‚îÄ‚îÄ production.yml
‚îÇ   ‚îî‚îÄ‚îÄ staging.yml
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îú‚îÄ‚îÄ all.yml
‚îÇ   ‚îú‚îÄ‚îÄ haproxy.yml
‚îÇ   ‚îú‚îÄ‚îÄ web.yml
‚îÇ   ‚îî‚îÄ‚îÄ db.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ haproxy/
‚îÇ   ‚îú‚îÄ‚îÄ keepalived/
‚îÇ   ‚îú‚îÄ‚îÄ web/
‚îÇ   ‚îú‚îÄ‚îÄ mysql/
‚îÇ   ‚îú‚îÄ‚îÄ varnish/
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îú‚îÄ‚îÄ deploy-cluster.yml
‚îÇ   ‚îú‚îÄ‚îÄ deploy-monitoring.yml
‚îÇ   ‚îî‚îÄ‚îÄ backup.yml
‚îî‚îÄ‚îÄ README.md
```

#### R√¥les Ansible √† cr√©er

**R√¥le `common` :**
- Configuration de base (hostname, timezone, NTP)
- Packages syst√®mes
- Utilisateurs et cl√©s SSH
- Configuration firewall de base

**R√¥le `haproxy` :**
- Installation HAProxy
- D√©ploiement de la configuration
- Installation des certificats SSL
- Tests de sant√©

**R√¥le `keepalived` :**
- Installation Keepalived
- Configuration VRRP
- Scripts de v√©rification

**R√¥le `web` :**
- Installation Apache/Nginx + PHP
- D√©ploiement de GLPI
- Configuration des Virtual Hosts
- Int√©gration avec le stockage partag√©

**R√¥le `mysql` :**
- Installation MySQL/MariaDB
- Configuration de la r√©plication
- Cr√©ation des bases et utilisateurs
- Tuning des performances

**R√¥le `monitoring` :**
- Installation des exporters Prometheus
- Configuration des agents

#### Playbook de d√©ploiement complet

Cr√©ez un playbook qui d√©ploie l'infrastructure compl√®te en une commande :
```yaml
# playbooks/deploy-cluster.yml
---
- name: Configure common settings
  hosts: all
  roles:
    - common

- name: Deploy HAProxy
  hosts: haproxy
  roles:
    - haproxy
    - keepalived

- name: Deploy web servers
  hosts: web
  roles:
    - web

- name: Deploy database servers
  hosts: db
  roles:
    - mysql

- name: Deploy monitoring
  hosts: monitoring
  roles:
    - monitoring
```

**Ex√©cution :**
```bash
ansible-playbook -i inventory/production.yml playbooks/deploy-cluster.yml
```

#### Idempotence et tests

Assurez-vous que vos playbooks sont **idempotents** :
- Peuvent √™tre rejou√©s sans effet de bord
- D√©tectent l'√©tat actuel avant de modifier
- Utilisent les modules Ansible appropri√©s (pas de `shell` brut)

**Testez** :
1. D√©ployez le cluster complet avec Ansible
2. Rejouez le playbook ‚Üí Aucune modification ne doit √™tre faite
3. Modifiez une configuration manuellement
4. Rejouez le playbook ‚Üí La configuration doit √™tre remise dans l'√©tat voulu

---

### T√¢che 9 ‚≠ê‚≠ê‚≠ê : Documentation automatis√©e

G√©n√©rez automatiquement la documentation de votre infrastructure.

#### Diagrammes d'architecture

Utilisez des outils de diagramme as code pour documenter l'architecture :

**Avec Diagrams (Python) :**
```python
from diagrams import Cluster, Diagram
from diagrams.onprem.network import HAProxy
from diagrams.onprem.database import MySQL
from diagrams.onprem.inmemory import Redis

with Diagram("GLPI Cluster", show=False):
    lb = HAProxy("HAProxy")

    with Cluster("Web Tier"):
        web_group = [Server("web01"),
                     Server("web02"),
                     Server("web03")]

    with Cluster("Database"):
        master = MySQL("master")
        slave = MySQL("slave")
        master >> slave

    lb >> web_group >> master
```

**Avec PlantUML :**
```plantuml
@startuml
node "HAProxy" as lb {
  [haproxy01]
  [haproxy02]
}

node "Web" as web {
  [glpi-web01]
  [glpi-web02]
  [glpi-web03]
}

database "MySQL" as db {
  [glpi-db01] as master
  [glpi-db02] as slave
}

lb --> web
web --> master
master .> slave : replication
@enduml
```

#### Inventaire automatis√©

Utilisez Ansible pour g√©n√©rer un inventaire √† jour :
```bash
ansible-inventory -i inventory/production.yml --list --yaml > inventory-export.yml
```

Ou cr√©ez un script qui g√©n√®re un document Markdown avec :
- Liste de tous les serveurs
- Adresses IP
- R√¥les
- Versions logicielles install√©es

#### Documentation des proc√©dures

Documentez toutes les proc√©dures op√©rationnelles en Markdown :

**Runbook √† cr√©er :**
- `procedures/deploiement-cluster.md` : D√©ploiement complet
- `procedures/ajout-noeud-web.md` : Ajouter un serveur web
- `procedures/basculement-bdd.md` : Basculer le master BDD
- `procedures/mise-a-jour-glpi.md` : Mettre √† jour GLPI
- `procedures/restauration-backup.md` : Restaurer depuis sauvegarde
- `procedures/renouvellement-certificats.md` : Renouveler les certificats SSL

**Int√©grez dans un wiki** (ex: GitLab Wiki, BookStack, DokuWiki) pour faciliter l'acc√®s.

---

### T√¢che 10 ‚≠ê‚≠ê‚≠ê : Tests finaux et validation

R√©alisez une batterie de tests pour valider l'ensemble de l'infrastructure.

#### Test 1 : Performance globale

Lancez un test de charge complet :
```bash
# Test de charge progressive
wrk -t12 -c100 -d30s --latency https://[VIP]/
wrk -t12 -c200 -d30s --latency https://[VIP]/
wrk -t12 -c400 -d30s --latency https://[VIP]/
```

**M√©triques √† atteindre :**
- Temps de r√©ponse moyen < 500ms
- 95e percentile < 1 seconde
- 99e percentile < 2 secondes
- Taux d'erreur < 0.1%
- D√©bit > 1000 req/s

#### Test 2 : R√©silience multi-pannes

Simulez des pannes simultan√©es multiples :

**Sc√©nario catastrophe :**
1. Arr√™tez `haproxy01` + `glpi-web01` simultan√©ment
2. Observez le basculement automatique
3. Le service doit rester disponible (br√®ve interruption acceptable)
4. Arr√™tez en plus `glpi-db01` (master)
5. Promouvoir `glpi-db02` (automatique si Master-Master)
6. Le service doit continuer de fonctionner

**Documentez** :
- Temps de reprise apr√®s chaque panne
- RTO/RPO r√©els mesur√©s
- Impact utilisateur

#### Test 3 : S√©curit√© applicative

Testez le WAF avec une suite d'attaques :
```bash
# Test injection SQL
sqlmap -u "https://[VIP]/front/computer.form.php?id=1" --batch --risk=3

# Test XSS
curl "https://[VIP]/search?q=<script>alert(1)</script>"

# Test Path Traversal
curl "https://[VIP]/../../../../etc/passwd"
```

‚úÖ **Attendu** : Toutes les attaques doivent √™tre bloqu√©es par ModSecurity.

#### Test 4 : Restauration compl√®te

**Test de disaster recovery :**

1. Prenez un snapshot complet de l'infrastructure
2. **D√©truisez compl√®tement le cluster** (supprimez toutes les VMs)
3. Restaurez depuis les sauvegardes uniquement
4. Mesurez le temps total de restauration (RTO r√©el)
5. V√©rifiez l'int√©grit√© des donn√©es (pas de perte)

**Objectif** : RTO < 30 minutes, RPO < 5 minutes.

#### Rapport final

R√©digez un **rapport de validation finale** incluant :

1. **Architecture d√©ploy√©e** : Sch√©mas et description
2. **Tests de performance** : R√©sultats des benchmarks
3. **Tests de r√©silience** : RTO/RPO mesur√©s, sc√©narios de panne
4. **S√©curit√©** : Tests WAF, PKI, authentification
5. **M√©triques atteintes** vs objectifs du cahier des charges
6. **Am√©liorations futures** : Pistes d'optimisation

---

## Livrables attendus

### ‚≠ê Livrables niveau 1 (obligatoires)

<CardGrid>
  <Card title="PKI compl√®te" icon="key">
    CA racine + interm√©diaire + certificats serveur d√©ploy√©s
  </Card>
  <Card title="Configuration Varnish" icon="rocket">
    Cache fonctionnel avec am√©lioration des performances mesur√©e
  </Card>
  <Card title="Script de sauvegarde" icon="backup">
    Automatisation compl√®te avec rotation et test de restauration
  </Card>
  <Card title="Documentation PKI" icon="document">
    Proc√©dure de g√©n√©ration et renouvellement des certificats
  </Card>
  <Card title="Tests de performance" icon="chart">
    Benchmarks avant/apr√®s optimisations
  </Card>
</CardGrid>

### ‚≠ê‚≠ê Livrables niveau 2

<CardGrid>
  <Card title="Optimisation MySQL" icon="database">
    Configuration tun√©e avec analyse des requ√™tes lentes
  </Card>
  <Card title="WAF ModSecurity" icon="shield">
    D√©ploy√© et tun√© avec tests d'attaques
  </Card>
  <Card title="Dashboards Grafana" icon="chart">
    5 dashboards personnalis√©s d√©ploy√©s
  </Card>
  <Card title="Alertes configur√©es" icon="warning">
    Alertes pertinentes avec notifications
  </Card>
</CardGrid>

### ‚≠ê‚≠ê‚≠ê Livrables niveau 3

<CardGrid>
  <Card title="Authentification LDAP" icon="users">
    Annuaire int√©gr√© avec synchronisation automatique
  </Card>
  <Card title="Infrastructure as Code" icon="code">
    Playbooks Ansible complets et idempotents
  </Card>
  <Card title="Documentation automatis√©e" icon="open-book">
    Diagrammes, inventaire et runbooks √† jour
  </Card>
  <Card title="Rapport de validation" icon="document">
    Tests complets avec m√©triques RTO/RPO
  </Card>
</CardGrid>

---

## Crit√®res d'√©valuation

| Crit√®re | ‚≠ê Niveau 1 | ‚≠ê‚≠ê Niveau 2 | ‚≠ê‚≠ê‚≠ê Niveau 3 |
|---------|------------|--------------|---------------|
| **PKI** | CA + certificats fonctionnels | Documentation compl√®te | Automatisation renouvellement |
| **Performance** | Cache Varnish actif | + Optimisation MySQL | Objectifs cahier charges atteints |
| **Sauvegarde** | Script automatis√© | + V√©rification int√©grit√© | Disaster recovery test√© |
| **S√©curit√©** | Certificats valides | + WAF d√©ploy√© et tun√© | + Auth centralis√©e LDAP |
| **Monitoring** | Dashboards de base | 5 dashboards + alertes | Monitoring proactif complet |
| **Automatisation** | Scripts manuels | Playbooks Ansible basiques | Infrastructure as Code compl√®te |
| **Documentation** | Proc√©dures √©crites | + Documentation technique | Doc auto-g√©n√©r√©e + runbooks |

:::tip[Conseils pour l'√©valuation]
- La **PKI interne** d√©montre une ma√Ætrise de la cryptographie appliqu√©e
- Les **tests de performance** avant/apr√®s doivent montrer des gains mesurables
- La **proc√©dure de restauration** doit √™tre test√©e r√©ellement, pas th√©orique
- L'**Infrastructure as Code** (‚≠ê‚≠ê‚≠ê) valorise fortement le travail
:::

---

## Ressources compl√©mentaires

- [OpenSSL CA Guide](https://jamielinux.com/docs/openssl-certificate-authority/)
- [Varnish Configuration](https://varnish-cache.org/docs/)
- [ModSecurity Handbook](https://www.feistyduck.com/books/modsecurity-handbook/)
- [Ansible Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [MySQL Performance Tuning](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
- [GLPI LDAP Configuration](https://glpi-project.org/)

:::tip[Conclusion du projet]
Avec cette mission, vous avez construit une infrastructure professionnelle compl√®te :
- ‚úÖ Haute disponibilit√© (Mission 5)
- ‚úÖ S√©curit√© renforc√©e (Missions 2, 3, 6)
- ‚úÖ Performance optimis√©e (Mission 6)
- ‚úÖ Supervision compl√®te (Mission 6)
- ‚úÖ Automatisation (Mission 6)

Votre infrastructure est maintenant pr√™te pour un environnement de production !
:::

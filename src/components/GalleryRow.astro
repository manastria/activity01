---
/**
 * GalleryRow.astro
 * RangÃ©e de miniatures avec GLightbox pour zoom + navigation.
 */
import { withBase, loadManifest, type ImageManifest } from "@/utils/images";

interface ImgItem {
  src: string;
  alt?: string;
  caption?: string;
}

interface Props {
  images: ImgItem[];
  group?: string;
  thumbHeight?: number;
  gap?: string;
}

const {
  images = [],
  group = "gallery-row",
  thumbHeight = 120,
  gap = "0.5rem",
} = Astro.props;

const manifest = await loadManifest();

function resolve(item: ImgItem, manifest: ImageManifest) {
  const entry = manifest[item.src];
  if (!entry) {
    return {
      full: { avif: null, webp: null, fallback: item.src },
      thumb: { avif: null, webp: null, fallback: null },
      alt: item.alt ?? "",
      caption: item.caption ?? "",
    };
  }
  return {
    full: entry.full,
    thumb: entry.thumb,
    alt: item.alt ?? "",
    caption: item.caption ?? "",
  };
}

const resolved = images.map((img) => resolve(img, manifest));
---

<div class="gallery-row" style={`--gap:${gap}; --thumb-h:${thumbHeight}px;`}>
  {resolved.map((img) => {
    const href = withBase(img.full.webp ?? img.full.fallback)!;
    const thumbAvif = withBase(img.thumb.avif);
    const thumbWebp = withBase(img.thumb.webp);
    const thumbFallback = withBase(img.thumb.fallback);
    const imgSrc = thumbFallback ?? withBase(img.full.webp) ?? withBase(img.full.fallback)!;
    const needsFallbackSizing = !thumbAvif && !thumbWebp && !thumbFallback;

    return (
      <a
        class="glx-item"
        href={href}
        data-type="image"
        data-gallery={group}
        data-title={img.caption}
        title={img.caption || img.alt}
      >
        <picture>
          {thumbAvif && <source srcset={thumbAvif} type="image/avif" />}
          {thumbWebp && <source srcset={thumbWebp} type="image/webp" />}
          <img
            src={imgSrc}
            alt={img.alt}
            loading="lazy"
            decoding="async"
            style={needsFallbackSizing ? "height: var(--thumb-h, 120px); width: auto;" : undefined}
          />
        </picture>
      </a>
    );
  })}
</div>

<style>
  .gallery-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap, 0.5rem);
    align-items: flex-start;
  }
  .gallery-row .glx-item {
    display: inline-flex;
    text-decoration: none;
    border: 0;
    outline: none;
  }
  .gallery-row img {
    height: var(--thumb-h, 120px);
    width: auto;
    max-width: 100%;
    border-radius: 8px;
    object-fit: cover;
    display: block;
    cursor: zoom-in;
  }
  .gallery-row .glx-item:focus-visible img {
    outline: 3px solid currentColor;
    outline-offset: 2px;
  }
</style>

<script>
  import GLightbox from "glightbox";
  import "glightbox/dist/css/glightbox.css";

  function init() {
    if (window.__glightboxInited) return;
    window.__glightboxInited = true;
    GLightbox({
      selector: "a.glx-item",
      touchNavigation: true,
      loop: false,
      zoomable: true,
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    init();
  }
</script>
